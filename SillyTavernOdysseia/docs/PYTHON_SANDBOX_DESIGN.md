# Pythonæ²™ç›’å®ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ¯ è®¾è®¡ç›®æ ‡

SillyTavern Odysseiaçš„Pythonæ²™ç›’ç³»ç»Ÿæ—¨åœ¨æä¾›ï¼š
- **å¼ºå¤§çš„Pythonç¼–ç¨‹èƒ½åŠ›**ï¼šæ”¯æŒå®Œæ•´çš„Pythonè¯­æ³•å’Œé€»è¾‘
- **å®Œå…¨å‘åå…¼å®¹**ï¼šæ— ç¼æ”¯æŒç°æœ‰SillyTavernå®
- **å®‰å…¨çš„æ‰§è¡Œç¯å¢ƒ**ï¼šä¸¥æ ¼çš„æ²™ç›’é™åˆ¶ï¼Œé˜²æ­¢æ¶æ„ä»£ç 
- **æ™ºèƒ½ä½œç”¨åŸŸç®¡ç†**ï¼šæ ¹æ®ä¸Šä¸‹æ–‡è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„å˜é‡ä½œç”¨åŸŸ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Pythonæ²™ç›’å®ç³»ç»Ÿ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚   å®è½¬æ¢å¤„ç†å™¨    â”‚  â”‚   Pythonæ²™ç®±     â”‚  â”‚   ä½œç”¨åŸŸç®¡ç†  â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚             â”‚
â”‚  â”‚ â€¢ SillyTavern   â”‚  â”‚ â€¢ å®‰å…¨æ‰§è¡Œ      â”‚  â”‚ â€¢ åˆ†å±‚å˜é‡   â”‚
â”‚  â”‚   å®è½¬æ¢        â”‚  â”‚ â€¢ ASTéªŒè¯       â”‚  â”‚ â€¢ å‰ç¼€è®¿é—®   â”‚
â”‚  â”‚ â€¢ Pythonå®æ‰§è¡Œ  â”‚  â”‚ â€¢ èµ„æºé™åˆ¶      â”‚  â”‚ â€¢ å‡½æ•°è®¿é—®   â”‚
â”‚  â”‚ â€¢ è‡ªåŠ¨æ£€æµ‹è½¬æ¢   â”‚  â”‚ â€¢ æ—¶é—´é™åˆ¶      â”‚  â”‚ â€¢ ä½œç”¨åŸŸéš”ç¦» â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ‰§è¡Œå¼•æ“                              â”‚
â”‚  â€¢ æœ€ç»ˆæç¤ºè¯æ‹¼æ¥ï¼ˆåº”ç”¨æ¬¡åºè§„åˆ™ï¼‰                         â”‚
â”‚  â€¢ ä»£ç å—æŒ‰åºæ‰§è¡Œï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰                            â”‚
â”‚  â€¢ å®å¤„ç†ï¼ˆä¼ ç»Ÿ+Pythonï¼‰                                â”‚
â”‚  â€¢ ç»“æœåˆå¹¶ä¸è¾“å‡º                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ä½œç”¨åŸŸç³»ç»Ÿ

### ä½œç”¨åŸŸç±»å‹

```python
# äº”ä¸ªä¸»è¦ä½œç”¨åŸŸ
preset_vars      = {}  # é¢„è®¾ä½œç”¨åŸŸ - ç³»ç»Ÿçº§é…ç½®
char_vars        = {}  # è§’è‰²ä½œç”¨åŸŸ - è§’è‰²ç›¸å…³çŠ¶æ€
world_vars       = {}  # ä¸–ç•Œä¹¦ä½œç”¨åŸŸ - ç¯å¢ƒå’Œä¸–ç•ŒçŠ¶æ€
conversation_vars = {} # å¯¹è¯ä½œç”¨åŸŸ - ä¼šè¯ç›¸å…³å˜é‡
global_vars      = {}  # å…¨å±€ä½œç”¨åŸŸ - è·¨ä¼šè¯å˜é‡

# ä¸´æ—¶ä½œç”¨åŸŸï¼ˆæ¯æ¬¡æ‰§è¡Œé‡ç½®ï¼‰
temp_vars        = {}  # å­˜å‚¨åŸºç¡€å®å˜é‡å’Œä¸´æ—¶è®¡ç®—ç»“æœ
```

### å˜é‡è®¿é—®æ–¹å¼

#### 1. ä½œç”¨åŸŸæ„ŸçŸ¥è®¿é—®
```python
# æ ¹æ®æ‰§è¡Œä¸Šä¸‹æ–‡è‡ªåŠ¨é€‰æ‹©ä½œç”¨åŸŸ
{{setvar::name::value}}  # é¢„è®¾ä¸­ â†’ preset_varsï¼Œè§’è‰²ä¸­ â†’ char_vars
{{getvar::name}}         # ä»å¯¹åº”ä½œç”¨åŸŸè·å–
```

#### 2. å‰ç¼€ç›´æ¥è®¿é—®
```python
{{python:preset_name}}     # ç›´æ¥è®¿é—® preset_vars['name']
{{python:char_level}}      # ç›´æ¥è®¿é—® char_vars['level']
{{python:world_location}}  # ç›´æ¥è®¿é—® world_vars['location']
```

#### 3. å‡½æ•°å¼è®¿é—®
```python
{{python:get_preset('name')}}      # å®‰å…¨è·å–ï¼Œä¸å­˜åœ¨è¿”å›ç©ºå­—ç¬¦ä¸²
{{python:set_char('level', 5)}}    # è®¾ç½®è§’è‰²å˜é‡
{{python:get_world('location')}}   # è·å–ä¸–ç•Œä¹¦å˜é‡
```

### ä½œç”¨åŸŸè‡ªåŠ¨æ£€æµ‹

ç³»ç»Ÿé€šè¿‡åˆ†æå†…å®¹æ¥æºè‡ªåŠ¨ç¡®å®šä½œç”¨åŸŸï¼š

```python
def _detect_content_scope(self, msg):
    content = msg.get('content', '')
    if 'worldInfoBefore' in content or 'worldInfoAfter' in content:
        return 'world'      # ä¸–ç•Œä¹¦å†…å®¹
    elif 'charDescription' in content:
        return 'char'       # è§’è‰²æè¿°
    elif 'chatHistory' in content:
        return 'conversation'  # å¯¹è¯å†å²
    else:
        return 'preset'     # é»˜è®¤é¢„è®¾ä½œç”¨åŸŸ
```

## ğŸ›¡ï¸ å®‰å…¨æ²™ç›’

### ASTå®‰å…¨æ£€æŸ¥

```python
FORBIDDEN_NODES = [
    ast.Import,      # ç¦æ­¢import
    ast.ImportFrom,  # ç¦æ­¢from...import
    ast.FunctionDef, # ç¦æ­¢å®šä¹‰å‡½æ•°
    ast.ClassDef,    # ç¦æ­¢å®šä¹‰ç±»
    ast.AsyncFunctionDef,  # ç¦æ­¢å¼‚æ­¥å‡½æ•°
    ast.Global,      # ç¦æ­¢globalå£°æ˜
    ast.Nonlocal,    # ç¦æ­¢nonlocalå£°æ˜
]
```

### æ‰§è¡Œé™åˆ¶

```python
# æ—¶é—´é™åˆ¶
@contextmanager
def _timeout_context(self):
    def timeout_handler(signum, frame):
        raise TimeoutError("ä»£ç æ‰§è¡Œè¶…æ—¶")
    
    signal.signal(signal.SIGALRM, timeout_handler)
    signal.alarm(5)  # 5ç§’é™åˆ¶
    try:
        yield
    finally:
        signal.alarm(0)
```

### å…è®¸çš„å†…ç½®å‡½æ•°

```python
ALLOWED_BUILTINS = {
    # åŸºç¡€æ•°æ®ç±»å‹
    'str', 'int', 'float', 'bool', 'list', 'dict', 'tuple', 'set',
    # æ•°å­¦å‡½æ•°
    'abs', 'max', 'min', 'sum', 'len', 'round',
    # å­—ç¬¦ä¸²å‡½æ•°
    'chr', 'ord',
    # ç±»å‹æ£€æŸ¥
    'isinstance', 'type',
    # å…¶ä»–å®‰å…¨å‡½æ•°
    'range', 'enumerate', 'zip', 'sorted', 'reversed',
}
```

## ğŸ”„ å®å…¼å®¹æ€§å’Œè½¬æ¢

### SillyTavernå®è‡ªåŠ¨è½¬æ¢

```python
def convert_tavern_macros_to_python(self, content: str) -> str:
    conversions = {
        # åŸºç¡€å˜é‡
        r'\{\{char\}\}': '{{python:char}}',
        r'\{\{user\}\}': '{{python:user}}',
        r'\{\{time\}\}': '{{python:time}}',
        r'\{\{date\}\}': '{{python:date}}',
        
        # å˜é‡æ“ä½œï¼ˆä½œç”¨åŸŸæ„ŸçŸ¥ï¼‰
        r'\{\{setvar::([^:}]+)::([^}]*)\}\}': r'{{python:setvar("\1", "\2")}}',
        r'\{\{getvar::([^}]+)\}\}': r'{{python:getvar("\1")}}',
        
        # å…¨å±€å˜é‡
        r'\{\{setglobalvar::([^:}]+)::([^}]*)\}\}': r'{{python:setglobalvar("\1", "\2")}}',
        r'\{\{getglobalvar::([^}]+)\}\}': r'{{python:getglobalvar("\1")}}',
    }
    
    for pattern, replacement in conversions.items():
        content = re.sub(pattern, replacement, content)
    
    return content
```

### Pythonå®æ‰§è¡Œ

```python
def process_python_macros(self, content: str, scope_type: str = 'temp') -> str:
    python_macro_pattern = r'\{\{python:(.*?)\}\}'
    
    def execute_python_macro(match):
        code = match.group(1)
        # ä½¿ç”¨æŒ‡å®šä½œç”¨åŸŸæ‰§è¡Œä»£ç 
        result = self.sandbox.execute_code(code, scope_type=scope_type)
        return str(result.result) if result.success else f"[é”™è¯¯: {result.error}]"
    
    return re.sub(python_macro_pattern, execute_python_macro, content, flags=re.DOTALL)
```

## ğŸ“‹ ä»£ç å—ç³»ç»Ÿ

### æ–‡ä»¶æ ¼å¼æ‰©å±•

æ‰€æœ‰é…ç½®æ–‡ä»¶éƒ½æ”¯æŒ`code_block`å­—æ®µï¼š

```json
{
  "name": "ç¤ºä¾‹æ¡ç›®",
  "content": "æ­£å¸¸å†…å®¹", 
  "code_block": "set_preset('initialized', True); print('æ‰§è¡Œå®Œæˆ')"
}
```

### æ‰§è¡Œé¡ºåº

```python
def execute_all_code_blocks_sequential(self) -> Dict[str, Any]:
    # 1. æ”¶é›†æ‰€æœ‰ä»£ç å—ï¼ŒæŒ‰æœ€ç»ˆæç¤ºè¯é¡ºåº
    code_blocks = self._collect_code_blocks_from_sources()
    
    # 2. åˆå§‹åŒ–æ²™ç›’
    sandbox = PythonSandbox()
    
    # 3. æŒ‰é¡ºåºæ‰§è¡Œ
    for block in code_blocks:
        result = sandbox.execute_code(
            block["code"], 
            scope_type=block["scope"]  # æ ¹æ®æ¥æºç¡®å®šä½œç”¨åŸŸ
        )
        # è®°å½•æ‰§è¡Œç»“æœ...
```

### ä½œç”¨åŸŸæ˜ å°„

```python
def _collect_code_blocks_from_sources(self) -> List[Dict[str, Any]]:
    code_blocks = []
    
    # è§’è‰²ä»£ç å— â†’ 'char'ä½œç”¨åŸŸ
    if self.character_data.get("code_block"):
        code_blocks.append({
            "source": "character", 
            "scope": "char",
            "code": self.character_data["code_block"]
        })
    
    # ä¸–ç•Œä¹¦ä»£ç å— â†’ 'world'ä½œç”¨åŸŸ
    for entry in self.world_book_entries:
        if entry.get("code_block"):
            code_blocks.append({
                "source": f"world_book_{entry.get('id', 'unknown')}",
                "scope": "world", 
                "code": entry["code_block"]
            })
    
    # é¢„è®¾ä»£ç å— â†’ 'preset'ä½œç”¨åŸŸ
    for prompt in self.preset_prompts:
        if prompt.get("code_block"):
            code_blocks.append({
                "source": f"preset_{prompt.get('identifier', 'unknown')}",
                "scope": "preset",
                "code": prompt["code_block"]
            })
    
    return code_blocks
```

## ğŸ­ æ‰§è¡Œæµç¨‹

### å¤šå†…å®¹éƒ¨åˆ†æ¶æ„æµç¨‹

```python
def to_final_prompt_openai(self, execute_code: bool = True) -> List[Dict[str, str]]:
    # 1. æ„å»ºæœ€ç»ˆæç¤ºè¯ï¼ˆä¿æŒå¤šå†…å®¹éƒ¨åˆ†ç»“æ„ï¼‰
    final_prompt = self.build_final_prompt()
    
    # 2. è½¬æ¢ä¸ºæ‰©å±•OpenAIæ ¼å¼ï¼ˆä¿ç•™content_partsä¿¡æ¯ï¼‰
    openai_messages = []
    for message in final_prompt:
        openai_msg = message.to_openai_format()  # åŒ…å«_content_partså­—æ®µ
        openai_messages.append(openai_msg)
    
    # 3. æ‰§è¡Œä»£ç å’Œå®å¤„ç†ï¼ˆç²¾ç¡®ä½œç”¨åŸŸæ„ŸçŸ¥ï¼‰
    if execute_code:
        openai_messages = self._execute_code_blocks_sequential(openai_messages)
    
    return openai_messages
```

### å…³é”®æ¶æ„æ”¹è¿›

#### 1. å»¶è¿Ÿåˆå¹¶ç­–ç•¥
- **æ„å»ºé˜¶æ®µ**: ChatMessageåŒ…å«å¤šä¸ªContentPartï¼Œæ¯ä¸ªä¿æŒæ¥æºæ ‡è®°
- **å¤„ç†é˜¶æ®µ**: ä¿æŒcontent_partsç»“æ„ï¼Œä¸è¿‡æ—©åˆå¹¶
- **è¾“å‡ºé˜¶æ®µ**: åªåœ¨æœ€ç»ˆè¾“å‡ºæ—¶ç”¨åŒæ¢è¡Œç¬¦åˆå¹¶

#### 2. ç²¾ç¡®ä½œç”¨åŸŸæ˜ å°„
```python
# æ¯ä¸ªContentPartçš„å®ä½¿ç”¨å…¶source_typeä½œç”¨åŸŸ
for part in message["_content_parts"]:
    part_content = part["content"]
    part_scope = part["source_type"]  # preset/char/world/conversation
    
    # å®å¤„ç†ä½¿ç”¨ç²¾ç¡®ä½œç”¨åŸŸ
    processed_content = process_macros(part_content, scope=part_scope)
```

### å®å’Œä»£ç å¤„ç†ï¼ˆå¤šå†…å®¹éƒ¨åˆ†æ¶æ„ï¼‰

```python
def _execute_code_blocks_sequential(self, openai_messages: List[Dict[str, str]]) -> List[Dict[str, str]]:
    # 1. å…ˆæ‰§è¡Œæ‰€æœ‰ä»£ç å—
    self.execute_all_code_blocks_sequential()
    
    # 2. å¤„ç†æ¯æ¡æ¶ˆæ¯ä¸­çš„å®ï¼ˆç²¾ç¡®ä½œç”¨åŸŸæ„ŸçŸ¥ï¼‰
    for msg in openai_messages:
        if "_content_parts" in msg and msg["_content_parts"]:
            # æ–°æ¶æ„ï¼šåˆ†åˆ«å¤„ç†æ¯ä¸ªå†…å®¹éƒ¨åˆ†
            processed_parts = []
            
            for part in msg["_content_parts"]:
                part_content = part["content"]
                part_scope = part["source_type"]  # ä½¿ç”¨è¯¥éƒ¨åˆ†çš„ç²¾ç¡®ä½œç”¨åŸŸ
                
                # 2.1 ä¼ ç»Ÿå®å¤„ç†
                part_content = self._macro_processor.process_macros(part_content)
                
                # 2.2 Pythonå®å¤„ç†ï¼ˆä½¿ç”¨è¯¥éƒ¨åˆ†çš„ä½œç”¨åŸŸï¼‰
                part_content = self._process_python_macros(part_content, part_scope)
                
                # 2.3 å†…è”Pythonä»£ç å—å¤„ç†
                part_content = self._execute_python_blocks_in_content(part_content, sandbox)
                
                processed_parts.append(part_content)
            
            # æœ€ç»ˆæ‹¼æ¥ï¼šç”¨åŒæ¢è¡Œç¬¦åˆå¹¶
            msg["content"] = "\n\n".join(processed_parts)
        else:
            # å‘åå…¼å®¹ï¼šå•ä¸€å†…å®¹æ¶ˆæ¯
            scope_type = self._detect_content_scope(msg)
            msg["content"] = self._macro_processor.process_macros(msg["content"])
            msg["content"] = self._process_python_macros(msg["content"], scope_type)
            msg["content"] = self._execute_python_blocks_in_content(msg["content"], sandbox)
    
    return openai_messages
```

## ğŸ“Š å˜é‡ç®¡ç†

### å˜é‡æ³¨å…¥

```python
def _inject_macro_variables(self):
    # æ³¨å…¥SillyTavernå…¼å®¹å˜é‡
    macro_vars = {
        'char': self.context.character_data.get('name', ''),
        'user': self.context.persona_data.get('name', 'User'),
        'description': self.context.character_data.get('description', ''),
        'time': self.context.current_time.strftime('%H:%M:%S'),
        'date': self.context.current_time.strftime('%Y-%m-%d'),
        
        # ä½œç”¨åŸŸæ„ŸçŸ¥çš„å˜é‡æ“ä½œå‡½æ•°
        'getvar': self._create_scoped_getvar(),
        'setvar': self._create_scoped_setvar(),
        
        # ä¿ç•™å˜é‡
        'enable': True,
    }
    
    # æ³¨å…¥åˆ°ä¸´æ—¶ä½œç”¨åŸŸ
    for name, value in macro_vars.items():
        self.sandbox.scope_manager.temp_vars[name] = value
```

### æ‰§è¡Œä¸Šä¸‹æ–‡åˆ›å»º

```python
def _create_execution_context(self, scope_type: str) -> Dict[str, Any]:
    context = {
        '__builtins__': {name: __builtins__[name] for name in ALLOWED_BUILTINS}
    }
    
    # æ·»åŠ å‰ç¼€å˜é‡ï¼ˆç›´æ¥è®¿é—®ï¼‰
    for name, value in self.conversation_vars.items():
        context[f'conv_{name}'] = value
    for name, value in self.preset_vars.items():
        context[f'preset_{name}'] = value
    for name, value in self.char_vars.items():
        context[f'char_{name}'] = value
    for name, value in self.world_vars.items():
        context[f'world_{name}'] = value
    for name, value in self.global_vars.items():
        context[f'global_{name}'] = value
    
    # æ·»åŠ ä½œç”¨åŸŸå‡½æ•°
    context.update({
        'get_conv': lambda name: self.conversation_vars.get(name, ''),
        'set_conv': lambda name, value: self.conversation_vars.update({name: value}),
        'get_preset': lambda name: self.preset_vars.get(name, ''),
        'set_preset': lambda name, value: self.preset_vars.update({name: value}),
        'get_char': lambda name: self.char_vars.get(name, ''),
        'set_char': lambda name, value: self.char_vars.update({name: value}),
        'get_world': lambda name: self.world_vars.get(name, ''),
        'set_world': lambda name, value: self.world_vars.update({name: value}),
        'get_global': lambda name: self.global_vars.get(name, ''),
        'set_global': lambda name, value: self.global_vars.update({name: value}),
    })
    
    # æ·»åŠ ä¸´æ—¶å˜é‡ï¼ˆç›´æ¥è®¿é—®ï¼‰
    context.update(self.temp_vars)
    
    return context
```

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```python
# ä¼ ç»Ÿå®ï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰
{{char}} â†’ è§’è‰²å
{{setvar::hp::100}} â†’ è®¾ç½®å½“å‰ä½œç”¨åŸŸçš„hpå˜é‡
{{getvar::hp}} â†’ è·å–å½“å‰ä½œç”¨åŸŸçš„hpå˜é‡

# Pythonå®
{{python:2 + 3}} â†’ 5
{{python:'Hello ' + char}} â†’ Hello è§’è‰²å
{{python:setvar('level', 5)}} â†’ è®¾ç½®å½“å‰ä½œç”¨åŸŸçš„levelå˜é‡
```

### é«˜çº§ä½¿ç”¨

```python
# è·¨ä½œç”¨åŸŸè®¿é—®
{{python:f"ç©å®¶{get_preset('name')}åœ¨{get_world('location')}"}}

# å¤æ‚é€»è¾‘
{{python:'æˆ˜æ–—ä¸­' if get_world('in_combat') else 'å’Œå¹³çŠ¶æ€'}}

# æ•°æ®å¤„ç†
{{python:sum([get_char(f'stat_{s}') for s in ['str', 'dex', 'int']])}}
```

### ä»£ç å—ä½¿ç”¨

```json
{
  "name": "è§’è‰²åˆå§‹åŒ–",
  "description": "å‹‡æ•¢çš„æˆ˜å£«",
  "code_block": "set_char('class', 'warrior'); set_char('level', 1); set_char('hp', 100)"
}
```

## ğŸ”§ è°ƒè¯•å’Œç›‘æ§

### æ‰§è¡Œç»“æœè¿½è¸ª

```python
def execute_all_code_blocks_sequential(self) -> Dict[str, Any]:
    execution_results = []
    
    for block in code_blocks:
        result = sandbox.execute_code(block["code"], scope_type=block["scope"])
        execution_results.append({
            "source": block["source"],
            "scope": block["scope"], 
            "success": result.success,
            "result": result.result,
            "error": result.error
        })
    
    return {
        "success": all(r["success"] for r in execution_results),
        "results": execution_results,
        "final_variables": {
            "preset": dict(sandbox.scope_manager.preset_vars),
            "char": dict(sandbox.scope_manager.char_vars),
            "world": dict(sandbox.scope_manager.world_vars),
            "conversation": dict(sandbox.scope_manager.conversation_vars),
            "global": dict(sandbox.scope_manager.global_vars),
        }
    }
```

### é”™è¯¯å¤„ç†

```python
class ExecutionResult:
    def __init__(self, success: bool, result: Any = None, error: str = None):
        self.success = success
        self.result = result
        self.error = error
        
    def __repr__(self):
        if self.success:
            return f"Success({self.result})"
        else:
            return f"Error({self.error})"
```

## ğŸ›£ï¸ æœ€ä½³å®è·µ

### 1. ä½œç”¨åŸŸä½¿ç”¨
- **é¢„è®¾ä½œç”¨åŸŸ**: ç³»ç»Ÿé…ç½®ã€åˆå§‹å€¼ã€å¸¸é‡
- **è§’è‰²ä½œç”¨åŸŸ**: è§’è‰²çŠ¶æ€ã€å±æ€§ã€èƒ½åŠ›
- **ä¸–ç•Œä¹¦ä½œç”¨åŸŸ**: ç¯å¢ƒçŠ¶æ€ã€å…¨å±€äº‹ä»¶ã€åœ°ç‚¹ä¿¡æ¯
- **å¯¹è¯ä½œç”¨åŸŸ**: ä¼šè¯çŠ¶æ€ã€ä¸´æ—¶æ ‡è®°ã€è½®æ¬¡è®¡æ•°

### 2. æ€§èƒ½ä¼˜åŒ–
- é¿å…å¤æ‚è®¡ç®—åœ¨å®ä¸­æ‰§è¡Œ
- ä½¿ç”¨ä»£ç å—è¿›è¡Œé‡é‡çº§åˆå§‹åŒ–
- åˆç†åˆ©ç”¨å˜é‡ç¼“å­˜ç»“æœ

### 3. å®‰å…¨è€ƒè™‘
- ä¸è¦å°è¯•ç»•è¿‡æ²™ç›’é™åˆ¶
- é¿å…æ— é™å¾ªç¯å’Œé€’å½’
- è°¨æ…å¤„ç†ç”¨æˆ·è¾“å…¥

### 4. è°ƒè¯•æŠ€å·§
```python
# æŸ¥çœ‹ä½œç”¨åŸŸå˜é‡
{{python:[k for k in dir() if k.startswith('char_')]}}

# æ¡ä»¶è°ƒè¯•è¾“å‡º
{{python:print(f"è°ƒè¯•: {getvar('hp')}") if enable else ""}}

# æ‰§è¡Œç»“æœæ£€æŸ¥
result = manager.execute_all_code_blocks_sequential()
print(result["final_variables"])
```

è¿™ä¸ªPythonæ²™ç›’ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„ç¼–ç¨‹èƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒäº†å®‰å…¨æ€§å’Œå‘åå…¼å®¹æ€§ã€‚é€šè¿‡æ™ºèƒ½çš„ä½œç”¨åŸŸç®¡ç†å’Œè‡ªåŠ¨å®è½¬æ¢ï¼Œç”¨æˆ·å¯ä»¥æ— ç¼ä»ä¼ ç»Ÿå®è¿ç§»åˆ°Pythonä»£ç ï¼Œäº«å—æ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚