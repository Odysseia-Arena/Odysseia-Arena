# API è¯·æ±‚å’Œå“åº”ç¤ºä¾‹

æœ¬æ–‡æ¡£æä¾›äº† SillyTavern Odysseia API çš„å®Œæ•´è¯·æ±‚å’Œå“åº”ç¤ºä¾‹ï¼Œæ¶µç›–æ‰€æœ‰ä¸»è¦ä½¿ç”¨åœºæ™¯ã€‚

## ğŸ“– ç›®å½•

- [åœºæ™¯1ï¼šinputä¸ºç©ºï¼ˆè§’è‰²å¡åˆå§‹æ¶ˆæ¯ï¼‰](#åœºæ™¯1inputä¸ºç©ºè§’è‰²å¡åˆå§‹æ¶ˆæ¯)
- [åœºæ™¯2ï¼šç®€å•ç”¨æˆ·è¾“å…¥](#åœºæ™¯2ç®€å•ç”¨æˆ·è¾“å…¥)
- [åœºæ™¯3ï¼šå®Œæ•´å¯¹è¯å†å²](#åœºæ™¯3å®Œæ•´å¯¹è¯å†å²)
- [åœºæ™¯4ï¼šå¸¦Assistant Responseå¤„ç†](#åœºæ™¯4å¸¦assistant-responseå¤„ç†)

---

## åœºæ™¯1ï¼šinputä¸ºç©ºï¼ˆè§’è‰²å¡åˆå§‹æ¶ˆæ¯ï¼‰

### ğŸ“¤ è¯·æ±‚æ ¼å¼

#### è¯·æ±‚æ‰€æœ‰æ ¼å¼
```json
{
  "character": {},
  "preset": {},
  "input": null,
  "output_formats": ["raw", "processed", "clean"]
}
```

#### åªè¯·æ±‚cleanæ ¼å¼
```json
{
  "character": {},
  "preset": {},
  "input": null,
  "output_formats": ["clean"]
}
```

### ğŸ“¥ å®Œæ•´å“åº”æ ¼å¼

#### è¯·æ±‚æ‰€æœ‰æ ¼å¼çš„å“åº”
```json
{
  "source_id": "req_...",
  "is_character_message": true,
  "processing_info": {
    "config_loaded": true,
    "message_count": 3,
    "output_formats": ["raw", "processed", "clean"],
    "prompt_blocks_raw_with_regex": 1,
    "prompt_blocks_processed_with_regex": 1,
    "prompt_blocks_clean_with_regex": 1
  },
  "raw_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "processed_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "clean_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "character_messages": {
    "user_view": [
      {
        "role": "assistant",
        "content": "ä½ å¥½ï¼æˆ‘æ˜¯æµ‹è¯•è§’è‰²ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼"
      },
      {
        "role": "assistant",
        "content": "å—¨ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
      },
      {
        "role": "assistant",
        "content": "æ¬¢è¿ï¼è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„å¯¹è¯å§ï¼"
      }
    ],
    "assistant_view": [
      {
        "role": "assistant",
        "content": "ä½ å¥½ï¼æˆ‘æ˜¯æµ‹è¯•è§’è‰²ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼"
      },
      {
        "role": "assistant",
        "content": "å—¨ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
      },
      {
        "role": "assistant",
        "content": "æ¬¢è¿ï¼è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„å¯¹è¯å§ï¼"
      }
    ]
  },
  "request": {
    "character": {},
    "preset": {},
    "input": null,
    "output_formats": ["raw", "processed", "clean"]
  }
}
```

#### åªè¯·æ±‚cleanæ ¼å¼çš„å“åº”
```json
{
  "source_id": "req_...",
  "is_character_message": true,
  "processing_info": {
    "config_loaded": true,
    "message_count": 3,
    "output_formats": ["clean"],
    "prompt_blocks_raw_with_regex": 0,
    "prompt_blocks_processed_with_regex": 1,
    "prompt_blocks_clean_with_regex": 1
  },
  "processed_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "clean_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11\n\nä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "character_messages": {
    "user_view": [
      {
        "role": "assistant",
        "content": "ä½ å¥½ï¼æˆ‘æ˜¯æµ‹è¯•è§’è‰²ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼"
      },
      {
        "role": "assistant",
        "content": "å—¨ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
      },
      {
        "role": "assistant",
        "content": "æ¬¢è¿ï¼è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„å¯¹è¯å§ï¼"
      }
    ],
    "assistant_view": [
      {
        "role": "assistant",
        "content": "ä½ å¥½ï¼æˆ‘æ˜¯æµ‹è¯•è§’è‰²ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼"
      },
      {
        "role": "assistant",
        "content": "å—¨ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
      },
      {
        "role": "assistant",
        "content": "æ¬¢è¿ï¼è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„å¯¹è¯å§ï¼"
      }
    ]
  },
  "request": {
    "character": {},
    "preset": {},
    "input": null,
    "output_formats": ["clean"]
  }
}
```

### ğŸ”‘ å…³é”®ç‰¹å¾ï¼ˆinputä¸ºç©ºæ—¶ï¼‰
- `is_character_message`: `true`
- åŒ…å« `character_messages` å­—æ®µï¼šç»è¿‡å®Œæ•´å¤„ç†çš„è§’è‰²å¡åˆå§‹æ¶ˆæ¯ï¼ŒåŒ…å«`user_view`å’Œ`assistant_view`ä¸¤ä¸ªè§†å›¾
- æç¤ºè¯ä¸»è¦åŒ…å«ç³»ç»Ÿæ¶ˆæ¯ï¼ˆè§’è‰²æè¿°ã€ä¸–ç•Œä¹¦ç­‰ï¼‰
- æ²¡æœ‰ç”¨æˆ·å¯¹è¯å†…å®¹
- `character_messages`ç»è¿‡å®å¤„ç†å’Œæ­£åˆ™è§„åˆ™å¤„ç†ï¼ŒåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡

---

## åœºæ™¯2ï¼šç®€å•ç”¨æˆ·è¾“å…¥

### ğŸ“¤ è¯·æ±‚æ ¼å¼
```json
{
  "character": {},
  "preset": {},
  "input": [
    {
      "role": "user",
      "content": "ä½ å¥½ï¼Œ{{char}}ï¼ç°åœ¨æ˜¯{{time}}ã€‚"
    }
  ],
  "output_formats": ["clean", "processed"]
}
```

### ğŸ“¥ å®Œæ•´å“åº”æ ¼å¼
```json
{
  "source_id": "req_...",
  "is_character_message": false,
  "processing_info": {
    "input_message_count": 1,
    "total_messages": 1,
    "triggered_entries": 0,
    "output_formats": ["clean", "processed"],
    "prompt_blocks_raw_with_regex": 0,
    "prompt_blocks_processed_with_regex": 3,
    "prompt_blocks_clean_with_regex": 3,
    "last_user_message": "ä½ å¥½ï¼Œ{{char}}ï¼ç°åœ¨æ˜¯{{time}}ã€‚"
  },
  "processed_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11"
      },
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œ{{char}}ï¼ç°åœ¨æ˜¯{{time}}ã€‚"
      },
      {
        "role": "system",
        "content": "ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11"
      },
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œ{{char}}ï¼ç°åœ¨æ˜¯{{time}}ã€‚"
      },
      {
        "role": "system",
        "content": "ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "clean_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11"
      },
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œ{{char}}ï¼ç°åœ¨æ˜¯{{time}}ã€‚"
      },
      {
        "role": "system",
        "content": "ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11"
      },
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œ{{char}}ï¼ç°åœ¨æ˜¯{{time}}ã€‚"
      },
      {
        "role": "system",
        "content": "ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "request": {
    "character": {},
    "preset": {},
    "input": [
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œ{{char}}ï¼ç°åœ¨æ˜¯{{time}}ã€‚"
      }
    ],
    "output_formats": ["clean", "processed"]
  }
}
```

### ğŸ”‘ å…³é”®ç‰¹å¾ï¼ˆæœ‰inputæ—¶ï¼‰
- `is_character_message`: `false`
- æ²¡æœ‰ `character_messages` å­—æ®µ
- æç¤ºè¯åŒ…å«ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
- `processing_info` åŒ…å«è¾“å…¥ç»Ÿè®¡ä¿¡æ¯

---

## åœºæ™¯3ï¼šå®Œæ•´å¯¹è¯å†å²

### ğŸ“¤ è¯·æ±‚æ ¼å¼
```json
{
  "character": {},
  "preset": {},
  "input": [
    {
      "role": "user",
      "content": "ä½ å¥½ï¼Œæˆ‘æƒ³è®¾ç½®ä¸€ä¸ªå˜é‡"
    },
    {
      "role": "assistant",
      "content": "å½“ç„¶å¯ä»¥ï¼ä½ æƒ³è®¾ç½®ä»€ä¹ˆå˜é‡ï¼Ÿ"
    },
    {
      "role": "user",
      "content": "è®¾ç½®è¡€é‡ï¼š{{setvar('hp', 100)}}ï¼Œå½“å‰è¡€é‡ï¼š{{getvar('hp')}}"
    }
  ],
  "output_formats": ["clean"]
}
```

### ğŸ“¥ å®Œæ•´å“åº”æ ¼å¼
```json
{
  "source_id": "req_...",
  "is_character_message": false,
  "processing_info": {
    "input_message_count": 3,
    "total_messages": 3,
    "triggered_entries": 0,
    "output_formats": ["clean"],
    "prompt_blocks_raw_with_regex": 0,
    "prompt_blocks_processed_with_regex": 5,
    "prompt_blocks_clean_with_regex": 5,
    "last_user_message": "è®¾ç½®è¡€é‡ï¼š{{setvar('hp', 100)}}ï¼Œå½“å‰è¡€é‡ï¼š{{getvar('hp')}}"
  },
  "processed_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11"
      },
      {
        "role": "user",
        "content": "è®¾ç½®è¡€é‡ï¼š{{setvar('hp', 100)}}ï¼Œå½“å‰è¡€é‡ï¼š{{getvar('hp')}}"
      },
      {
        "role": "assistant",
        "content": "å½“ç„¶å¯ä»¥ï¼ä½ æƒ³è®¾ç½®ä»€ä¹ˆå˜é‡ï¼Ÿ"
      },
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œæˆ‘æƒ³è®¾ç½®ä¸€ä¸ªå˜é‡"
      },
      {
        "role": "system",
        "content": "ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11"
      },
      {
        "role": "user",
        "content": "è®¾ç½®è¡€é‡ï¼š{{setvar('hp', 100)}}ï¼Œå½“å‰è¡€é‡ï¼š{{getvar('hp')}}"
      },
      {
        "role": "assistant",
        "content": "å½“ç„¶å¯ä»¥ï¼ä½ æƒ³è®¾ç½®ä»€ä¹ˆå˜é‡ï¼Ÿ"
      },
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œæˆ‘æƒ³è®¾ç½®ä¸€ä¸ªå˜é‡"
      },
      {
        "role": "system",
        "content": "ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "clean_prompt": {
    "user_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11"
      },
      {
        "role": "user",
        "content": "è®¾ç½®è¡€é‡ï¼š{{setvar('hp', 100)}}ï¼Œå½“å‰è¡€é‡ï¼š{{getvar('hp')}}"
      },
      {
        "role": "assistant",
        "content": "å½“ç„¶å¯ä»¥ï¼ä½ æƒ³è®¾ç½®ä»€ä¹ˆå˜é‡ï¼Ÿ"
      },
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œæˆ‘æƒ³è®¾ç½®ä¸€ä¸ªå˜é‡"
      },
      {
        "role": "system",
        "content": "ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ],
    "assistant_view": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ã€‚å½“å‰è§’è‰²ï¼šæµ‹è¯•è§’è‰²ï¼Œç”¨æˆ·ï¼šç”¨æˆ·11"
      },
      {
        "role": "user",
        "content": "è®¾ç½®è¡€é‡ï¼š{{setvar('hp', 100)}}ï¼Œå½“å‰è¡€é‡ï¼š{{getvar('hp')}}"
      },
      {
        "role": "assistant",
        "content": "å½“ç„¶å¯ä»¥ï¼ä½ æƒ³è®¾ç½®ä»€ä¹ˆå˜é‡ï¼Ÿ"
      },
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œæˆ‘æƒ³è®¾ç½®ä¸€ä¸ªå˜é‡"
      },
      {
        "role": "system",
        "content": "ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œå–œæ¬¢å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜ã€‚\n\næè¿°\n\nå½“å‰è§’è‰²å¤„äºå‹å–„æ¨¡å¼ï¼Œä¼šç§¯æå¸®åŠ©ç”¨æˆ·ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚\n\nè®°ä½è¦ä¿æŒç¤¼è²Œå’Œå‹å–„çš„æ€åº¦ã€‚"
      }
    ]
  },
  "request": {
    "character": {},
    "preset": {},
    "input": [
      {
        "role": "user",
        "content": "ä½ å¥½ï¼Œæˆ‘æƒ³è®¾ç½®ä¸€ä¸ªå˜é‡"
      },
      {
        "role": "assistant",
        "content": "å½“ç„¶å¯ä»¥ï¼ä½ æƒ³è®¾ç½®ä»€ä¹ˆå˜é‡ï¼Ÿ"
      },
      {
        "role": "user",
        "content": "è®¾ç½®è¡€é‡ï¼š{{setvar('hp', 100)}}ï¼Œå½“å‰è¡€é‡ï¼š{{getvar('hp')}}"
      }
    ],
    "output_formats": ["clean"]
  }
}
```

### ğŸ”‘ å…³é”®ç‰¹å¾ï¼ˆå¤šè½®å¯¹è¯ï¼‰
- åŒ…å«å®Œæ•´çš„user/assistantå¯¹è¯å†å²
- æ¶ˆæ¯æ•°é‡å¢åŠ ï¼Œ`input_message_count`: 3
- ä¿æŒå¯¹è¯çš„æ—¶åºé¡ºåº

---

## åœºæ™¯4ï¼šå¸¦Assistant Responseå¤„ç†

### ğŸ“¤ è¯·æ±‚æ ¼å¼
```json
{
  "character": {},
  "preset": {},
  "input": [
    {
      "role": "user",
      "content": "è¯·å‘Šè¯‰æˆ‘å½“å‰çŠ¶æ€"
    }
  ],
  "assistant_response": {
    "role": "assistant",
    "content": "å½“å‰çŠ¶æ€ï¼š{{setvar('status', 'active')}}{{getvar('status')}}ï¼Œéšæœºæ•°ï¼š{{roll::1d6}}"
  },
  "output_formats": ["clean"]
}
```

### ğŸ“¥ å®Œæ•´å“åº”æ ¼å¼
```json
{
  "source_id": "req_...",
  "is_character_message": false,
  "processing_info": {
    "input_message_count": 1,
    "assistant_response_processed": true,
    "output_formats": ["clean"],
    "formats_generated": ["clean"]
  },
  "clean_prompt": {
    "user_view": [
      {
        "role": "user",
        "content": "è¯·å‘Šè¯‰æˆ‘å½“å‰çŠ¶æ€"
      },
      {
        "role": "assistant",
        "content": "å½“å‰çŠ¶æ€ï¼šactiveï¼Œéšæœºæ•°ï¼š1"
      }
    ],
    "assistant_view": [
      {
        "role": "user",
        "content": "è¯·å‘Šè¯‰æˆ‘å½“å‰çŠ¶æ€"
      },
      {
        "role": "assistant",
        "content": "å½“å‰çŠ¶æ€ï¼šactiveï¼Œéšæœºæ•°ï¼š1"
      }
    ]
  },
  "request": {
    "character": {},
    "preset": {},
    "input": [
      {
        "role": "user",
        "content": "è¯·å‘Šè¯‰æˆ‘å½“å‰çŠ¶æ€"
      }
    ],
    "output_formats": ["clean"]
  }
}
```

### ğŸ”‘ å…³é”®ç‰¹å¾ï¼ˆAssistant Responseå¤„ç†ï¼‰
- `assistant_response_processed`: `true` æ ‡è¯†
- å®è¢«æ­£ç¡®å¤„ç†ï¼š
  - `{{setvar('status', 'active')}}{{getvar('status')}}` â†’ `"active"`
  - `{{roll::1d6}}` â†’ `"1"` (éšæœºæ•°)
- æœ€ç»ˆåŒ…å«å¤„ç†åçš„assistantæ¶ˆæ¯
- `request` ä¸­ä¸æ˜¾ç¤º `assistant_response` å­—æ®µï¼ˆå†…éƒ¨å¤„ç†ï¼‰

---

## ğŸ¯ å­—æ®µå¯¹æ¯”æ€»ç»“

| å­—æ®µ | inputä¸ºç©º | inputä¸ä¸ºç©º | å¸¦Assistant Response |
|------|-----------|-------------|---------------------|
| `is_character_message` | `true` | `false` | `false` |
| `character_messages` | âœ… å®Œæ•´æ¶ˆæ¯å—æ ¼å¼ï¼ŒåŒ…å«ä¸¤ä¸ªè§†å›¾ | âŒ ä¸å­˜åœ¨ | âŒ ä¸å­˜åœ¨ |
| `processing_info.message_count` | âœ… è§’è‰²å¡æ¶ˆæ¯æ•° | âŒ ä¸å­˜åœ¨ | âŒ ä¸å­˜åœ¨ |
| `processing_info.character_messages_processed` | âœ… `true` | âŒ ä¸å­˜åœ¨ | âŒ ä¸å­˜åœ¨ |
| `processing_info.input_message_count` | âŒ ä¸å­˜åœ¨ | âœ… è¾“å…¥æ¶ˆæ¯æ•° | âœ… è¾“å…¥æ¶ˆæ¯æ•° |
| `processing_info.assistant_response_processed` | âŒ ä¸å­˜åœ¨ | âŒ ä¸å­˜åœ¨ | âœ… `true` |
| æç¤ºè¯å†…å®¹ | ç³»ç»Ÿæ¶ˆæ¯ä¸ºä¸» | ç³»ç»Ÿ+ç”¨æˆ·æ¶ˆæ¯ | ç”¨æˆ·+å¤„ç†ååŠ©æ‰‹æ¶ˆæ¯ |

## ğŸ“ ä½¿ç”¨å»ºè®®

### **å‰ç«¯åˆ¤æ–­é€»è¾‘**
```javascript
// åˆ¤æ–­å“åº”ç±»å‹
if (response.is_character_message) {
  // è§’è‰²å¡åˆå§‹æ¶ˆæ¯
  const userViewMessages = response.character_messages.user_view;
  const assistantViewMessages = response.character_messages.assistant_view;
  const systemPrompt = response.clean_prompt.assistant_view;
  
  // character_messagesç°åœ¨æ˜¯å®Œæ•´çš„æ¶ˆæ¯å—æ ¼å¼ï¼Œå¯ç›´æ¥å‘é€ç»™AI
  // userViewMessages: ç”¨æˆ·çœ‹åˆ°çš„æ ¼å¼ï¼ˆå¯èƒ½åŒ…å«éšè—çš„è°ƒè¯•ä¿¡æ¯ç­‰ï¼‰
  // assistantViewMessages: å‘é€ç»™AIçš„æ ¼å¼ï¼ˆæ ‡å‡†OpenAIæ ¼å¼ï¼‰
} else {
  // æ™®é€šå¯¹è¯
  const conversation = response.clean_prompt.assistant_view;
  
  if (response.processing_info.assistant_response_processed) {
    // å¸¦Assistant Responseå¤„ç†çš„å¯¹è¯
    console.log("Assistantå“åº”å·²å¤„ç†");
  }
}
```

### **æ ¼å¼é€‰æ‹©å»ºè®®**
- **`raw`**: è°ƒè¯•ç”¨ï¼ŒæŸ¥çœ‹åŸå§‹æœªå¤„ç†å†…å®¹
- **`processed`**: å¼€å‘ç”¨ï¼Œä¿ç•™å…ƒæ•°æ®å’Œæ¥æºä¿¡æ¯
- **`clean`**: ç”Ÿäº§ç”¨ï¼Œæ ‡å‡†OpenAIæ ¼å¼ï¼Œå¯ç›´æ¥å‘é€ç»™AIæ¨¡å‹

### **è§†å›¾é€‰æ‹©å»ºè®®**
- **`user_view`**: å±•ç¤ºç»™ç”¨æˆ·çš„ç•Œé¢
- **`assistant_view`**: å‘é€ç»™AIæ¨¡å‹çš„å†…å®¹

è¿™ä»½æ–‡æ¡£æä¾›äº†å®Œæ•´çš„APIä½¿ç”¨å‚è€ƒï¼Œå¯ä»¥å¸®åŠ©å‰ç«¯å¼€å‘è€…æ­£ç¡®å¤„ç†å„ç§åœºæ™¯ä¸‹çš„è¯·æ±‚å’Œå“åº”ã€‚
