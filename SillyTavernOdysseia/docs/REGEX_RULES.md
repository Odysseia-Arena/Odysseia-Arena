# æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢è§„åˆ™ç³»ç»Ÿ

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» SillyTavern Odysseia çš„æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢è§„åˆ™ç³»ç»Ÿï¼ŒåŒ…æ‹¬åŸºæœ¬æ¦‚å¿µã€ä½¿ç”¨æ–¹æ³•å’Œç¤ºä¾‹ã€‚

## 1. æ¦‚è¿°

æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢è§„åˆ™ç³»ç»Ÿå…è®¸æ‚¨åœ¨æç¤ºè¯æ„å»ºè¿‡ç¨‹ä¸­çµæ´»åœ°åº”ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä»¥ä¿®æ”¹å’Œè½¬æ¢æç¤ºè¯å†…å®¹ã€‚è¿™ä¸ªç³»ç»Ÿå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **çµæ´»çš„ä½œç”¨èŒƒå›´**ï¼šå¯ä»¥é’ˆå¯¹ç‰¹å®šæ·±åº¦ã€æ¬¡åºå’Œå†…å®¹ç±»å‹çš„æç¤ºè¯åº”ç”¨è§„åˆ™
- **å¤šç§å¤„ç†æ—¶æœº**ï¼šåœ¨å®å¤„ç†å‰æˆ–ååº”ç”¨ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡æˆ–åŒ…å«å®å†…éƒ¨å­—ç¬¦
- **ä¸åŒè§†å›¾ç±»å‹**ï¼šå¯ä»¥åªä¿®æ”¹æŸä¸€ç§è§†å›¾çš„æç¤ºè¯ï¼Œä¸å½±å“å…¶ä»–è§†å›¾
- **æ™ºèƒ½è·³è¿‡æœºåˆ¶**ï¼šè‡ªåŠ¨è·³è¿‡relativeä½ç½®çš„å†…å®¹ï¼Œç¡®ä¿åªå¤„ç†èŠå¤©å†å²å’ŒåŠ¨æ€å†…å®¹ âœ¨**æ–°å¢**
- **ç®€åŒ–çš„è§„åˆ™æ’åº**ï¼šç§»é™¤äº†ä¼˜å…ˆçº§å­—æ®µï¼Œä½¿è§„åˆ™æ’åºæ›´ç›´è§‚
- **ä¸é…’é¦†æ ¼å¼å…¼å®¹**ï¼šæä¾›è½¬æ¢å·¥å…·ï¼Œæ”¯æŒä»é…’é¦†æ­£åˆ™æ ¼å¼è½¬æ¢

## ğŸ”’ **æ™ºèƒ½è·³è¿‡æœºåˆ¶ (Relative Field Skipping)** âœ¨**æ–°å¢**

### å·¥ä½œåŸç†

æ­£åˆ™è§„åˆ™ç³»ç»Ÿå…·æœ‰æ™ºèƒ½è·³è¿‡åŠŸèƒ½ï¼Œä¼šè‡ªåŠ¨è·³è¿‡å…·æœ‰"relative"ä½ç½®æ ‡è¯†çš„å†…å®¹éƒ¨åˆ†ï¼š

```python
# ç¤ºä¾‹ï¼šæ£€æŸ¥æ¶ˆæ¯çš„_source_identifiers
message = {
    "role": "system",
    "content": "ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹",
    "_source_identifiers": ["main:relative", "worldInfoBefore:relative"]
}
# æ­¤æ¶ˆæ¯ä¼šè¢«è·³è¿‡ï¼Œä¸åº”ç”¨ä»»ä½•æ­£åˆ™è§„åˆ™
```

### è·³è¿‡æ¡ä»¶

ç³»ç»Ÿæ£€æŸ¥æ¯ä¸ªæ¶ˆæ¯çš„`_source_identifiers`å­—æ®µï¼Œå¦‚æœåŒ…å«ä»»ä½•ä»¥`:relative`ç»“å°¾çš„æ ‡è¯†ç¬¦ï¼Œåˆ™è·³è¿‡æ­£åˆ™å¤„ç†ï¼š

- `main:relative` - ä¸»è¦é¢„è®¾ï¼ˆç›¸å¯¹ä½ç½®ï¼‰
- `systemPrompt:relative` - ç³»ç»Ÿæç¤ºï¼ˆç›¸å¯¹ä½ç½®ï¼‰
- `worldInfoBefore:relative` - ä¸–ç•Œä¹¦å‰ç½®å†…å®¹
- `worldInfoAfter:relative` - ä¸–ç•Œä¹¦åç½®å†…å®¹
- `charDescription:relative` - è§’è‰²æè¿°
- `personaDescription:relative` - ç”¨æˆ·è§’è‰²æè¿°

### å¤„ç†çš„å†…å®¹

åªæœ‰å…·æœ‰ä»¥ä¸‹æ ‡è¯†ç¬¦çš„å†…å®¹ä¼šè¢«æ­£åˆ™è§„åˆ™å¤„ç†ï¼š

- `user_input:in-chat:depth_X` - ç”¨æˆ·è¾“å…¥ï¼ˆèŠå¤©å†å²ï¼‰
- `assistant_response:in-chat:depth_X` - AIå“åº”ï¼ˆèŠå¤©å†å²ï¼‰
- `world_entry_X` - è§¦å‘çš„ä¸–ç•Œä¹¦æ¡ç›®
- `assistant_response_processing` - å¤„ç†ä¸­çš„AIå“åº”

### è®¾è®¡ç›®æ ‡

è¿™ç§è®¾è®¡ç¡®ä¿ï¼š
1. **ç¨³å®šæ€§**: ç³»ç»Ÿé¢„è®¾å’Œå›ºå®šå†…å®¹ä¸è¢«æ„å¤–ä¿®æ”¹
2. **ç²¾ç¡®æ€§**: æ­£åˆ™è§„åˆ™åªä½œç”¨äºçœŸæ­£çš„èŠå¤©å†…å®¹
3. **å¯é¢„æµ‹æ€§**: é¿å…ç›¸å¯¹ä½ç½®å†…å®¹çš„ä¸å½“å˜æ›´

## 2. æ­£åˆ™è§„åˆ™æ•°æ®ç»“æ„

æ¯ä¸ªæ­£åˆ™è§„åˆ™ç”±ä»¥ä¸‹å­—æ®µç»„æˆï¼š

```json
{
  "id": "rule_1",                               // è§„åˆ™å”¯ä¸€æ ‡è¯†ç¬¦
  "name": "ç¤ºä¾‹è§„åˆ™",                            // è§„åˆ™åç§°
  "enabled": true,                              // è§„åˆ™æ˜¯å¦å¯ç”¨
  "find_regex": "pattern",                      // æŸ¥æ‰¾çš„æ­£åˆ™è¡¨è¾¾å¼
  "replace_regex": "replacement",               // æ›¿æ¢çš„æ­£åˆ™è¡¨è¾¾å¼
  "targets": ["user", "assistant_response"],    // ä½œç”¨å¯¹è±¡
  "placement": "after_macro",                   // ä½œç”¨æ—¶æœº
  "views": ["user_view", "assistant_view"],     // ä½œç”¨æ•ˆæœ
  "min_depth": 1,                               // æœ€å°æ·±åº¦
  "max_depth": 5,                               // æœ€å¤§æ·±åº¦
  "min_order": 10,                              // æœ€å°order
  "max_order": 20,                              // æœ€å¤§order
  "description": "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹è§„åˆ™"              // è§„åˆ™æè¿°
}
```

### 2.1 å­—æ®µè¯´æ˜

- **id**: è§„åˆ™çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªUUIDæˆ–è‡ªå®šä¹‰å­—ç¬¦ä¸²
- **name**: è§„åˆ™çš„åç§°ï¼Œç”¨äºåœ¨ç•Œé¢æˆ–æ—¥å¿—ä¸­æ˜¾ç¤º
- **enabled**: æ˜¯å¦å¯ç”¨è§„åˆ™ï¼Œ`true`è¡¨ç¤ºå¯ç”¨ï¼Œ`false`è¡¨ç¤ºç¦ç”¨
- **find_regex**: æŸ¥æ‰¾çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ”¯æŒå®Œæ•´çš„æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•
- **replace_regex**: æ›¿æ¢çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ”¯æŒæ•è·ç»„å¼•ç”¨ï¼ˆå¦‚`$1`ï¼‰
- **targets**: è§„åˆ™çš„ä½œç”¨å¯¹è±¡ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å€¼çš„æ•°ç»„ï¼š
  - `"user"`: ç”¨æˆ·æ¶ˆæ¯
  - `"assistant_response"`: AIåŠ©æ‰‹å›å¤
  - `"world_book"`: ä¸–ç•Œä¹¦æ¡ç›®
  - `"preset"`: é¢„è®¾æ¡ç›®
  - `"assistant_thinking"`: AIæ€è€ƒè¿‡ç¨‹
- **placement**: ä½œç”¨æ—¶æœºï¼Œå†³å®šäº†è§„åˆ™åœ¨æç¤ºè¯æ„å»ºè¿‡ç¨‹ä¸­çš„åº”ç”¨æ—¶æœºï¼š
  - `"before_macro_skip"`: åœ¨å®å¤„ç†å‰åº”ç”¨æ­£åˆ™ï¼Œä½†è·³è¿‡å®çš„å†…éƒ¨å­—ç¬¦
  - `"before_macro_include"`: åœ¨å®å¤„ç†å‰åº”ç”¨æ­£åˆ™ï¼ŒåŒ…æ‹¬å®çš„å†…éƒ¨å­—ç¬¦
  - `"after_macro"`: åœ¨å®å¤„ç†ååº”ç”¨æ­£åˆ™
- **views**: ä½œç”¨æ•ˆæœï¼Œä¸€ä¸ªåŒ…å« `"user_view"` æˆ– `"assistant_view"` çš„æ•°ç»„ã€‚å®ƒå†³å®šäº†è§„åˆ™ä¿®æ”¹å“ªä¸€ä¸ªï¼ˆæˆ–å“ªäº›ï¼‰è¾“å‡ºè§†å›¾ã€‚
  - **é‡è¦**: å¦‚æœæ­¤å­—æ®µ**æœªè®¾ç½®æˆ–ä¸ºç©ºæ•°ç»„ `[]`**ï¼Œè¯¥è§„åˆ™å°†**ä¸åº”ç”¨äºä»»ä½•è§†å›¾**ï¼Œå³è§„åˆ™æ— æ•ˆã€‚å¿…é¡»æ˜¾å¼æŒ‡å®šè‡³å°‘ä¸€ä¸ªè§†å›¾ã€‚
- **min_depth / max_depth**: è§„åˆ™åº”ç”¨çš„æ·±åº¦èŒƒå›´ï¼Œ`null`è¡¨ç¤ºä¸é™åˆ¶
- **min_order / max_order**: è§„åˆ™åº”ç”¨çš„æ¬¡åºèŒƒå›´ï¼Œ`null`è¡¨ç¤ºä¸é™åˆ¶
- **description**: è§„åˆ™çš„æè¿°ï¼Œç”¨äºè¯´æ˜è§„åˆ™çš„ä½œç”¨

## 3. è§„åˆ™å­˜å‚¨å’Œé…ç½®

### 3.1 è§„åˆ™æ–‡ä»¶

æ­£åˆ™è§„åˆ™ä»¥JSONæ–‡ä»¶å½¢å¼å­˜å‚¨åœ¨`data/regex_rules/`ç›®å½•ä¸‹ï¼Œæ¯ä¸ªæ–‡ä»¶å¯ä»¥åŒ…å«ä¸€ä¸ªè§„åˆ™æˆ–ä¸€ä¸ªè§„åˆ™æ•°ç»„ï¼š

```json
[
  {
    "id": "rule_1",
    "name": "è§„åˆ™1",
    "find_regex": "pattern1",
    "replace_regex": "replacement1",
    ...
  },
  {
    "id": "rule_2",
    "name": "è§„åˆ™2",
    "find_regex": "pattern2",
    "replace_regex": "replacement2",
    ...
  }
]
```

### 3.2 é…ç½®æ–‡ä»¶é›†æˆ

åœ¨é…ç½®æ–‡ä»¶ï¼ˆ`data/configs/xxx.json`ï¼‰ä¸­ï¼Œå¯ä»¥é€šè¿‡`regex_rules`å­—æ®µæŒ‡å®šè¦ä½¿ç”¨çš„æ­£åˆ™è§„åˆ™æ–‡ä»¶ï¼š

```json
{
  "config_id": "test_config",
  "name": "æµ‹è¯•é…ç½®",
  "description": "ç”¨äºç³»ç»Ÿæµ‹è¯•çš„å®Œæ•´é…ç½®ç»„åˆ",
  "components": {
    "preset": "test_preset.simplified.json",
    "character": "test_character.simplified.json",
    "persona": "User.json",
    "additional_world_book": "test_world.json",
    "regex_rules": [
      "example_rules.json",
      "custom_rules.json"
    ]
  },
  "tags": ["æµ‹è¯•", "API"],
  "created_date": "2025-08-29T21:30:16.270807",
  "last_used": "2025-08-29T21:30:16.270807"
}
```

## 4. ä½œç”¨æ—¶æœºä¸è§†å›¾ç³»ç»Ÿ

### 4.1 ä½œç”¨æ—¶æœºï¼ˆplacementï¼‰

è§„åˆ™çš„ä½œç”¨æ—¶æœºæ˜¯é€šè¿‡`placement`å­—æ®µæŒ‡å®šçš„ï¼Œå®ƒå†³å®šäº†è§„åˆ™åœ¨æç¤ºè¯æ„å»ºè¿‡ç¨‹ä¸­çš„åº”ç”¨æ—¶æœºï¼š

1. **before_macro_skip**ï¼šåœ¨å®å¤„ç†å‰åº”ç”¨æ­£åˆ™ï¼Œä½†è·³è¿‡å®çš„å†…éƒ¨å­—ç¬¦
   - è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¼šå…ˆæ‰¾åˆ°æ‰€æœ‰çš„å®ï¼ˆå¦‚`{{user}}`ï¼‰ï¼Œå°†å®ƒä»¬æ›¿æ¢ä¸ºä¸´æ—¶å ä½ç¬¦
   - ç„¶ååº”ç”¨æ­£åˆ™æ›¿æ¢ï¼Œæœ€åå°†å ä½ç¬¦æ›¿æ¢å›åŸæ¥çš„å®
   - é€‚ç”¨äºéœ€è¦ä¿®æ”¹å®å‘¨å›´å†…å®¹ä½†ä¸å½±å“å®æœ¬èº«çš„æƒ…å†µ

2. **before_macro_include**ï¼šåœ¨å®å¤„ç†å‰åº”ç”¨æ­£åˆ™ï¼ŒåŒ…æ‹¬å®çš„å†…éƒ¨å­—ç¬¦
   - è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œæ­£åˆ™æ›¿æ¢ä¼šåº”ç”¨åˆ°æ•´ä¸ªå†…å®¹ï¼ŒåŒ…æ‹¬å®çš„å†…éƒ¨å­—ç¬¦
   - é€‚ç”¨äºéœ€è¦ä¿®æ”¹å®å†…å®¹æˆ–å®æœ¬èº«çš„æƒ…å†µ

3. **after_macro**ï¼šåœ¨å®å¤„ç†ååº”ç”¨æ­£åˆ™
   - è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰å®éƒ½å·²ç»è¢«å¤„ç†ï¼Œæ­£åˆ™æ›¿æ¢ä¼šåº”ç”¨åˆ°å¤„ç†åçš„å†…å®¹
   - é€‚ç”¨äºå¯¹å®å¤„ç†åçš„å†…å®¹è¿›è¡Œè¿›ä¸€æ­¥ä¿®æ”¹

### 4.2 è§†å›¾ç³»ç»Ÿ (views)

è§†å›¾ç³»ç»Ÿçš„æ ¸å¿ƒç›®æ ‡æ˜¯åŒºåˆ†ä¸åŒè§†å›¾çš„æç¤ºè¯å†…å®¹ï¼Œå¹¶å…è®¸æ­£åˆ™è§„åˆ™å¯¹å®ƒä»¬è¿›è¡Œç‹¬ç«‹æˆ–ç»Ÿä¸€çš„ä¿®æ”¹ã€‚

ç³»ç»ŸåŒ…å«ä¸‰ç§åŸºæœ¬è§†å›¾ï¼Œæ¯ç§è§†å›¾éƒ½æœ‰åº”ç”¨æ­£åˆ™å‰åä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ€»å…±å…­ç§æç¤ºè¯æ ¼å¼ï¼š

1. **åŸºç¡€è§†å›¾ï¼ˆæœªåº”ç”¨æ­£åˆ™ï¼‰**:
   - `raw_prompt`: åŸå§‹è§†å›¾ï¼ŒåŒ…å«å…¨éƒ¨å†…å®¹
   - `processed_prompt`: ç”¨æˆ·è§†å›¾ï¼ŒåŒ…å«å…ƒæ•°æ®ï¼ˆç”¨æˆ·çœ‹åˆ°çš„å†…å®¹ï¼‰
   - `clean_prompt`: AIè§†å›¾ï¼Œæ ‡å‡†OpenAIæ ¼å¼ï¼ˆå‘é€ç»™AIçš„å†…å®¹ï¼‰

2. **åº”ç”¨æ­£åˆ™åçš„è§†å›¾**:
   - `raw_prompt_with_regex`: åº”ç”¨æ­£åˆ™åçš„åŸå§‹è§†å›¾
   - `processed_prompt_with_regex`: åº”ç”¨æ­£åˆ™åçš„ç”¨æˆ·è§†å›¾ï¼ˆæœ€ç»ˆç”¨æˆ·çœ‹åˆ°çš„å†…å®¹ï¼‰
   - `clean_prompt_with_regex`: åº”ç”¨æ­£åˆ™åçš„AIè§†å›¾ï¼ˆæœ€ç»ˆå‘é€ç»™AIçš„å†…å®¹ï¼‰

**æ ¸å¿ƒè§„åˆ™**:
-   **æ˜¾å¼æŒ‡å®š**: å¿…é¡»åœ¨ `views` å­—æ®µä¸­æ˜ç¡®æŒ‡å®šè‡³å°‘ä¸€ç§è§†å›¾ï¼Œè§„åˆ™æ‰ä¼šç”Ÿæ•ˆ:
    -   `"raw_view"`: ä¿®æ”¹åŸå§‹è§†å›¾
    -   `"user_view"`: ä¿®æ”¹ç”¨æˆ·è§†å›¾
    -   `"assistant_view"`: ä¿®æ”¹AIè§†å›¾
-   **æ— æ•ˆè§„åˆ™**: å¦‚æœä¸€ä¸ªè§„åˆ™**æ²¡æœ‰ `views` å­—æ®µï¼Œæˆ–è€…è¯¥å­—æ®µæ˜¯ç©ºæ•°ç»„ `[]`**ï¼Œé‚£ä¹ˆå®ƒå°†**ä¸ä¼š**è¢«åº”ç”¨äºä»»ä½•è§†å›¾ã€‚
-   **ç²¾ç¡®æ§åˆ¶**:
    -   `"views": ["raw_view"]`: åªä¿®æ”¹åŸå§‹è§†å›¾ã€‚
    -   `"views": ["user_view"]`: åªä¿®æ”¹ç”¨æˆ·çœ‹åˆ°çš„å†…å®¹ã€‚
    -   `"views": ["assistant_view"]`: åªä¿®æ”¹å‘é€ç»™AIçš„å†…å®¹ã€‚
    -   `"views": ["user_view", "assistant_view"]`: åŒæ—¶ä¿®æ”¹ç”¨æˆ·è§†å›¾å’ŒAIè§†å›¾ã€‚
    -   `"views": ["raw_view", "user_view", "assistant_view"]`: ä¿®æ”¹æ‰€æœ‰è§†å›¾ã€‚

**é‡è¦**: æ­£åˆ™è§„åˆ™**ä¸ä¼š**ä¿®æ”¹åŸºç¡€çš„æç¤ºè¯æ•°æ®ã€‚æ‰€æœ‰è§†å›¾çš„è½¬æ¢éƒ½æ˜¯åœ¨ç‹¬ç«‹çš„å‰¯æœ¬ä¸Šè¿›è¡Œçš„ï¼Œç¡®ä¿äº†åº•å±‚æ•°æ®çš„çº¯å‡€å’Œå¯é¢„æµ‹æ€§ã€‚

**è§†å›¾åº”ç”¨ä¸¾ä¾‹**ï¼š
- åŸå§‹å†…å®¹: `å†…éƒ¨è°ƒè¯•ä¿¡æ¯ [debug_info: x=5]`
- **è§„åˆ™1**: `find: "\\[debug_info:.*?\\]"`, `replace: "[è°ƒè¯•ä¿¡æ¯å·²å¯¹æ‚¨éšè—]"` , `"views": ["user_view"]`
- **è§„åˆ™2**: `find: "\\[debug_info: x=(.*?)\\]"`, `replace: "[ç³»ç»Ÿæç¤ºï¼šå˜é‡xçš„å€¼æ˜¯$1]"` , `"views": ["assistant_view"]`
- **è§„åˆ™3**: `find: "å†…éƒ¨è°ƒè¯•ä¿¡æ¯"`, `replace: "ç³»ç»Ÿè°ƒè¯•"` , `"views": ["raw_view"]`

**æœ€ç»ˆç»“æœ**:
-   **åŸå§‹è§†å›¾ (`raw_prompt_with_regex`)**: `ç³»ç»Ÿè°ƒè¯• [debug_info: x=5]`
-   **ç”¨æˆ·çœ‹åˆ°çš„ (`processed_prompt_with_regex`)**: `å†…éƒ¨è°ƒè¯•ä¿¡æ¯ [è°ƒè¯•ä¿¡æ¯å·²å¯¹æ‚¨éšè—]`
-   **å‘é€ç»™AIçš„ (`clean_prompt_with_regex`)**: `å†…éƒ¨è°ƒè¯•ä¿¡æ¯ [ç³»ç»Ÿæç¤ºï¼šå˜é‡xçš„å€¼æ˜¯5]`

**é‡è¦è¯´æ˜**ï¼š`placement`å’Œ`views`æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼š
- `placement`æ§åˆ¶è§„åˆ™åº”ç”¨çš„**æ—¶æœº**ï¼ˆå®å¤„ç†å‰æˆ–åï¼‰
- `views`æ§åˆ¶è§„åˆ™åº”ç”¨çš„**æ•ˆæœ**ï¼ˆä¿®æ”¹å“ªäº›è¾“å‡ºè§†å›¾ï¼‰

ä¸€ä¸ªè§„åˆ™å¯ä»¥åŒæ—¶æŒ‡å®šä½œç”¨æ—¶æœºå’Œè§†å›¾ç±»å‹ï¼Œä¾‹å¦‚ï¼š`"placement": "after_macro", "views": ["user_view", "raw_view"]`

## 5. ä½¿ç”¨ç¤ºä¾‹

### 5.1 åŸºæœ¬ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€äº›åŸºæœ¬çš„æ­£åˆ™è§„åˆ™ç¤ºä¾‹ï¼ŒåŒ…å«è§†å›¾å­—æ®µçš„ä½¿ç”¨ï¼š

```json
// ç¤ºä¾‹1ï¼šåŒæ—¶å½±å“ç”¨æˆ·å’ŒAI
{
  "id": "rule_1",
  "name": "ç»Ÿä¸€æ ¼å¼åŒ–",
  "enabled": true,
  "find_regex": "SillyTavern",
  "replace_regex": "SillyTavern Odysseia",
  "targets": ["user", "assistant_response"],
  "placement": "after_macro",
  "views": ["user_view", "assistant_view"]
}

// ç¤ºä¾‹2ï¼šä»…ä¸ºç”¨æˆ·è§†å›¾éšè—ä¿¡æ¯
{
  "id": "rule_2",
  "name": "ä¸ºç”¨æˆ·éšè—å†…éƒ¨ID",
  "enabled": true,
  "find_regex": "(\\(entry_id: \\d+\\))",
  "replace_regex": "", // æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²ä»¥åˆ é™¤
  "targets": ["world_book", "preset"],
  "placement": "after_macro",
  "views": ["user_view"]
}

// ç¤ºä¾‹3ï¼šä»…ä¸ºAIè§†å›¾æ·»åŠ æŒ‡ä»¤
{
  "id": "rule_3",
  "name": "ä¸ºAIæ·»åŠ è§’è‰²æ‰®æ¼”æé†’",
  "enabled": true,
  "find_regex": "(^.*$)",
  "replace_regex": "$1\n[ç³»ç»Ÿæé†’ï¼šè¯·ä¸¥æ ¼ä»¥è§’è‰²çš„èº«ä»½å’Œå£å»è¿›è¡Œå›ç­”]",
  "targets": ["assistant_response"],
  "placement": "after_macro",
  "views": ["assistant_view"],
  "min_depth": 1, // åªåœ¨ç¬¬ä¸€æ¡AIæ¶ˆæ¯åæ·»åŠ 
  "max_depth": 1
}
```

### 5.2 æ•è·ç»„å’Œå¼•ç”¨

æ­£åˆ™æ›¿æ¢æ”¯æŒæ•è·ç»„å’Œå¼•ç”¨ï¼Œå¯ä»¥ä½¿ç”¨`$1`, `$2`ç­‰å¼•ç”¨æ•è·ç»„ï¼š

```json
{
  "id": "rule_4",
  "name": "æ ¼å¼åŒ–å…³é”®è¯",
  "enabled": true,
  "find_regex": "å…³é”®è¯\\s*[:ï¼š]\\s*(.+?)\\s*(?=$|,|ï¼Œ|;|ï¼›)",
  "replace_regex": "ã€å…³é”®è¯ã€‘ $1",
  "targets": ["preset", "world_book"],
  "placement": "after_macro"
}
```

### 5.3 ä¿ç•™å®çš„æ­£åˆ™æ›¿æ¢

ä½¿ç”¨`before_macro_skip`æ¨¡å¼å¯ä»¥åœ¨ä¿ç•™å®çš„æƒ…å†µä¸‹ä¿®æ”¹å‘¨å›´å†…å®¹ï¼š

```json
{
  "id": "rule_5",
  "name": "ä¿ç•™å®çš„æ ¼å¼åŒ–",
  "enabled": true,
  "find_regex": "è‡ªå®šä¹‰æ ¼å¼ï¼š(.+)",
  "replace_regex": "æ ¼å¼åŒ–å†…å®¹ï¼š$1",
  "targets": ["preset", "user", "assistant_response"],
  "placement": "before_macro_skip"
}
```

## 6. é…’é¦†æ­£åˆ™æ ¼å¼è½¬æ¢

æä¾›äº†è½¬æ¢è„šæœ¬`scripts/convert_tavern_regex.py`ï¼Œç”¨äºå°†é…’é¦†çš„æ­£åˆ™æ ¼å¼è½¬æ¢ä¸ºOdysseiaçš„RegexRuleæ ¼å¼ã€‚

### 6.1 é…’é¦†æ ¼å¼æ˜ å°„

é…’é¦†æ­£åˆ™æ ¼å¼ä¸Odysseiaæ­£åˆ™æ ¼å¼çš„æ˜ å°„å…³ç³»ï¼š

| é…’é¦†å­—æ®µ | Odysseiaå­—æ®µ | è¯´æ˜ |
|---------|-------------|------|
| id | id | è§„åˆ™å”¯ä¸€æ ‡è¯†ç¬¦ |
| scriptName | name | è§„åˆ™åç§° |
| findRegex | find_regex | æŸ¥æ‰¾çš„æ­£åˆ™è¡¨è¾¾å¼ |
| replaceString | replace_regex | æ›¿æ¢çš„æ­£åˆ™è¡¨è¾¾å¼ |
| placement | targets | ä½œç”¨å¯¹è±¡ï¼Œæ˜ å°„å…³ç³»ï¼š<br>1 -> "user"<br>2 -> "assistant_response"<br>5 -> "world_book"<br>6 -> "assistant_thinking" |
| disabled | enabled | è§„åˆ™æ˜¯å¦å¯ç”¨ï¼Œå–åå€¼ |
| minDepth/maxDepth | depth | ä½œç”¨æ·±åº¦ |
| minOrder/maxOrder | order | ä½œç”¨æ¬¡åº |

### 6.2 ä½¿ç”¨è½¬æ¢è„šæœ¬

```bash
# è½¬æ¢å•ä¸ªæ–‡ä»¶
python scripts/convert_tavern_regex.py è¾“å…¥tag.json

# æŒ‡å®šè¾“å‡ºæ–‡ä»¶
python scripts/convert_tavern_regex.py è¾“å…¥tag.json -o data/regex_rules/æˆ‘çš„è§„åˆ™.json

# åˆå¹¶ç°æœ‰è§„åˆ™
python scripts/convert_tavern_regex.py è¾“å…¥tag.json -c

# è½¬æ¢æ•´ä¸ªç›®å½•
python scripts/convert_tavern_regex.py è§„åˆ™ç›®å½•/ -o è¾“å‡ºç›®å½•/
```

## 7. APIå‚è€ƒ

### 7.1 RegexRuleManager

```python
# åˆ›å»ºè§„åˆ™ç®¡ç†å™¨
from src.services.regex_rule_manager import RegexRuleManager
rule_manager = RegexRuleManager("data/regex_rules")

# åº”ç”¨è§„åˆ™åˆ°å†…å®¹
processed_content = rule_manager.apply_regex_to_content(
    content="åŸå§‹å†…å®¹",
    source_type="conversation",  # å†…å®¹æ¥æºç±»å‹
    depth=1,                     # æ·±åº¦ï¼ˆå¯é€‰ï¼‰
    order=100,                   # æ¬¡åºï¼ˆå¯é€‰ï¼‰
    placement="after_macro",     # å¤„ç†é˜¶æ®µ
    view="original"              # è§†å›¾ç±»å‹ï¼šoriginal/user_view/assistant_view
)

# è·å–æ‰€æœ‰è§„åˆ™
rules = rule_manager.get_rules()

# è·å–è§„åˆ™åº”ç”¨ç»Ÿè®¡ä¿¡æ¯
stats = rule_manager.get_stats()
```

### 7.2 ChatHistoryManager

```python
# åŸºç¡€è§†å›¾ (æœªåº”ç”¨æ­£åˆ™)
raw_prompt = chat_manager.to_raw_openai_format()              # åŸå§‹è§†å›¾
processed_prompt = chat_manager.to_processed_openai_format()  # å¤„ç†åè§†å›¾ (å¸¦å…ƒæ•°æ®)
clean_prompt = chat_manager.to_clean_openai_format()          # çº¯å‡€è§†å›¾ (æ ‡å‡†OpenAIæ ¼å¼)

# åº”ç”¨æ­£åˆ™åçš„è§†å›¾
raw_prompt_with_regex = chat_manager.to_raw_with_regex_format()            # åŸå§‹è§†å›¾+æ­£åˆ™
processed_prompt_with_regex = chat_manager.to_processed_with_regex_format() # ç”¨æˆ·è§†å›¾+æ­£åˆ™
clean_prompt_with_regex = chat_manager.to_clean_with_regex_format()         # AIè§†å›¾+æ­£åˆ™

# ç›´æ¥æŒ‡å®šè§†å›¾ç±»å‹
custom_prompt = chat_manager.build_final_prompt(view_type="processed_with_regex") # æ”¯æŒæ‰€æœ‰å…­ç§è§†å›¾ç±»å‹
```

## 8. æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®ä½œç”¨èŒƒå›´**ï¼šé€šè¿‡ `min_depth`/`max_depth` å’Œ `min_order`/`max_order` ç²¾ç¡®æ§åˆ¶è§„åˆ™çš„åº”ç”¨èŒƒå›´
2. **è°¨æ…ä½¿ç”¨before_macro_include**ï¼šè¿™ç§æ¨¡å¼å¯èƒ½ä¼šä¿®æ”¹å®å†…å®¹ï¼Œå¯¼è‡´å®æ— æ³•æ­£ç¡®è§£æ
3. **å°½é‡é™åˆ¶ä½œç”¨èŒƒå›´**ï¼šé€šè¿‡targetsã€`min_depth`/`max_depth`å’Œ`min_order`/`max_order`é™åˆ¶è§„åˆ™çš„ä½œç”¨èŒƒå›´ï¼Œé¿å…è¿‡åº¦ä¿®æ”¹
4. **é’ˆå¯¹ä¸åŒå¤„ç†é˜¶æ®µè®¾ç½®ä¸åŒè§„åˆ™**ï¼š`before_macro_skip`ã€`before_macro_include`å’Œ`after_macro`åˆ†åˆ«å¯¹åº”ä¸åŒçš„å¤„ç†é˜¶æ®µ
5. **ä½¿ç”¨æ•è·ç»„ä¿ç•™å†…å®¹**ï¼šä½¿ç”¨æ­£åˆ™æ•è·ç»„ï¼ˆå¦‚`()`ï¼‰å¹¶åœ¨æ›¿æ¢ä¸­å¼•ç”¨ï¼ˆå¦‚`$1`ï¼‰å¯ä»¥ä¿ç•™éƒ¨åˆ†å†…å®¹
6. **å®šæœŸæ£€æŸ¥è§„åˆ™ç»Ÿè®¡**ï¼šé€šè¿‡get_stats()æ£€æŸ¥è§„åˆ™çš„åº”ç”¨æƒ…å†µï¼Œæ‰¾å‡ºæ— æ•ˆæˆ–å†—ä½™çš„è§„åˆ™
7. **åˆç†ä½¿ç”¨è§†å›¾ç³»ç»Ÿ**ï¼š
   - **å¿…é¡»**æ˜¾å¼è®¾ç½® `views` å­—æ®µï¼Œå¦åˆ™è§„åˆ™ä¸ä¼šç”Ÿæ•ˆã€‚
   - å¦‚æœå¸Œæœ›ä¸€ä¸ªè§„åˆ™å¯¹ç”¨æˆ·å’ŒAIéƒ½ç”Ÿæ•ˆï¼Œè¯·ä½¿ç”¨ `"views": ["user_view", "assistant_view"]`ã€‚
   - ä½¿ç”¨ `user_view` æ¥ä¼˜åŒ–æ˜¾ç¤ºã€æ¸…ç†æ ¼å¼æˆ–éšè—ä¸å¸Œæœ›ç”¨æˆ·çœ‹åˆ°çš„å†…éƒ¨æ ‡è®°ã€‚
   - ä½¿ç”¨ `assistant_view` æ¥â€œç§˜å¯†åœ°â€æŒ‡å¯¼AIï¼Œå¢å¼ºå…¶è§’è‰²æ‰®æ¼”èƒ½åŠ›æˆ–æä¾›ä¸Šä¸‹æ–‡çº¿ç´¢ã€‚