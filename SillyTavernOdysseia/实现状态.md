# SillyTavern 宏实现状态

## 📊 实现进度总览

**当前实现率：51% (43/85个宏)**

## ✅ 已实现的宏功能

### 系统范围的替换宏
- `{{newline}}` – 仅插入一个换行符 ✅
- `{{trim}}` – 修剪此宏周围的换行符 ✅ **新增**
- `{{noop}}` – 空操作，返回空字符串 ✅
- `{{// (note)}}` – 注释宏，不产生输出 ✅

### 角色和用户信息
- `{{user}}` – 当前用户角色名称 ✅
- `{{char}}` – 角色的名字 ✅
- `{{description}}` – 角色描述 ✅
- `{{personality}}` – 人物性格 ✅
- `{{scenario}}` – 角色场景 ✅
- `{{persona}}` – 当前角色描述 ✅

### 消息相关
- `{{input}}` – 用户输入 ✅
- `{{lastMessage}}` – 最新聊天消息的文本 ✅
- `{{lastUserMessage}}` – 最后的用户聊天消息文本 ✅
- `{{lastCharMessage}}` – 最后的角色聊天消息文本 ✅
- `{{messageCount}}` – 消息计数 ✅
- `{{userMessageCount}}` – 用户消息计数 ✅
- `{{conversationLength}}` – 对话长度 ✅

### 时间和日期
- `{{time}}` – 当前时间 ✅
- `{{date}}` – 当前日期 ✅
- `{{weekday}}` – 当前工作日 ✅
- `{{isotime}}` – 当前 ISO 时间（24 小时制）✅
- `{{isodate}}` – 当前 ISO 日期 (YYYY-MM-DD) ✅
- `{{datetimeformat …}}` – 指定格式的当前日期/时间 ✅ **新增**
- `{{time_UTC±#}}` – 指定 UTC 时区偏移量的当前时间 ✅ **新增**
- `{{timeDiff::(time1)::(time2)}}` – time1 和 time2 之间的时间差 ✅ **新增**

### 随机和选择
- `{{roll:(formula)}}` – 掷骰子 ✅
- `{{random:(args)}}` – 从列表中返回一个随机项目 ✅
- `{{random::(arg1)::(arg2)}}` – 随机的替代语法 ✅
- `{{pick::(args)}}` – 持久化随机选择（会话内保持一致）✅ **新增**

### 变量操作
#### 局部变量
- `{{getvar::name}}` – 替换为局部变量"name"的值 ✅
- `{{setvar::name::value}}` – 设置局部变量"name"为"value" ✅
- `{{addvar::name::increment}}` – 将数值添加到局部变量"name" ✅
- `{{incvar::name}}` – 变量"name"的值增加 1 ✅
- `{{decvar::name}}` – 变量"name"的值减 1 ✅

#### 全局变量
- `{{getglobalvar::name}}` – 替换为全局变量"name"的值 ✅
- `{{setglobalvar::name::value}}` – 设置全局变量"name"为"value" ✅
- `{{addglobalvar::name::value}}` – 将数值添加到全局变量"name" ✅ **新增**
- `{{incglobalvar::name}}` – 全局变量"name"的值增加 1 ✅ **新增**
- `{{decglobalvar::name}}` – 全局变量"name"的值减 1 ✅ **新增**

### 字符串操作
- `{{reverse:(content)}}` – 反转宏的内容 ✅
- `{{upper:text}}` – 转换为大写 ✅
- `{{lower:text}}` – 转换为小写 ✅
- `{{length:text}}` – 获取文本长度 ✅

### 数学运算
- `{{add:a:b}}` – 加法运算 ✅
- `{{sub:a:b}}` – 减法运算 ✅
- `{{mul:a:b}}` – 乘法运算 ✅
- `{{div:a:b}}` – 除法运算 ✅
- `{{max:a:b}}` – 取最大值 ✅
- `{{min:a:b}}` – 取最小值 ✅

## ❌ 未实现的宏功能

### 系统控制宏
- `{{pipe}}` – 仅适用于斜线命令批处理，替换为上一个命令的返回结果
- `{{original}}` – API 设置中定义的全局提示
- `{{lastGenerationType}}` - 最后排队生成请求的类型

### 高级角色信息
- `{{charPrompt}}` – 角色的主提示覆盖
- `{{charInstruction}}` – 角色越狱提示覆盖
- `{{mesExamples}}` – 角色对话示例
- `{{mesExamplesRaw}}` – 未格式化的对话示例
- `{{version}}` – 角色的版本号
- `{{charDepthPrompt}}` – 角色的 @ Depth Note

### 群聊功能
- `{{group}}` – 以逗号分隔的群成员名称列表
- `{{groupNotMuted}}` – 与 {{group}} 相同，但排除被禁言的成员

### 消息索引
- `{{lastMessageId}}` – 最新聊天消息的索引号
- `{{firstIncludedMessageId}}` – 上下文中包含的第一条消息的 ID
- `{{firstDisplayedMessageId}}` – 第一条载入可见聊天的消息的ID
- `{{currentSwipeId}}` – 最后一条聊天消息中当前滑动的 ID
- `{{lastSwipeId}}` – 最后一条聊天消息中的滑动次数

### AI 控制
- `{{model}}` – 当前选定的 API 的文本生成模型名称
- `{{bias "text here"}}` – 为 AI 设置行为偏差
- `{{banned "text here"}}` – 动态地将引号中的文本添加到禁用单词序列中

### 活动状态
- `{{idle_duration}}` – 距离上次用户消息发送的时间
- `{{summary}}` – "Summarize"扩展生成的最新聊天摘要
- `{{isMobile}}` – 当为移动端时为"true"，反之为"false"

### 指导模式和上下文模板宏（约20个）
- `{{maxPrompt}}` – 令牌中允许的最大提示长度
- `{{exampleSeparator}}` – 上下文模板示例对话分隔符
- `{{chatStart}}` – 上下文模板聊天开始行
- `{{systemPrompt}}` – 主系统提示
- `{{defaultSystemPrompt}}` – 指示系统提示
- 以及其他指导模式相关宏...

### STscript 范围变量
- `{{var::name}}` – 替换为范围变量"name"的值
- `{{var::name::index}}` – 用范围变量"name"的索引处的项目值

## 🎯 下一步实现优先级

### 🟢 容易实现的高价值功能
1. `{{version}}` – 角色版本号
2. `{{mesExamples}}` – 角色对话示例
3. `{{mesExamplesRaw}}` – 未格式化对话示例
4. `{{isMobile}}` – 移动端检测

### 🟡 中等难度的实用功能
1. `{{lastMessageId}}` – 消息ID系统
2. `{{idle_duration}}` – 活动状态追踪
3. `{{group}}` / `{{groupNotMuted}}` – 群聊支持

### 🔴 复杂的系统集成功能
1. `{{bias}}` / `{{banned}}` – AI 后端控制
2. 指导模式宏群 – 完整的提示系统
3. `{{pipe}}` – 斜线命令系统
4. `{{var::name}}` – STscript 集成

---

**总结：** 我们已经实现了核心的宏功能，包括变量操作、时间处理、随机选择等。目前的实现已经能够满足大部分日常使用需求，为进一步的功能扩展奠定了良好的基础。
