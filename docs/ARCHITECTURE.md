# 系统架构文档

## 项目概述
创意写作大模型竞技场是一个让不同AI模型进行创意写作对战的平台。用户可以对比不同模型的创作质量并投票，系统使用Glicko-2评分系统维护模型排行榜。

## 项目阶段
- **分级匹配**（当前）：系统将模型分为高、低两个等级，并在各自等级内进行匹配对战。
- **动态排位**：系统会根据模型评分，每日自动执行升降级。

## 系统架构图

```
┌─────────────────────────────────────────────┐
│                 客户端                       │
│        (Discord Bot / Web Interface)        │
└─────────────────┬───────────────────────────┘
                  │ HTTP/REST API
                  ↓
┌─────────────────────────────────────────────┐
│            FastAPI Server                    │
│           (arena_server.py)                  │
├─────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐        │
│  │Battle Control│  │Vote Control  │        │
│  │Controller    │  │Controller    │        │
│  └──────┬───────┘  └──────┬───────┘        │
│         │                  │                 │
│  ┌──────┴──────────────────┴───────┐        │
│  │        Storage Layer            │        │
│  │      (SQLite Database)          │        │
│  └──────────────────────────────────┘        │
│                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │Glicko-2 Rating│  │Tier Manager  │  │Model Client  │   │
│  │   System     │  │ (升降级管理) │  │  (API调用)   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────┘
```

## 核心模块说明

### 1. **arena_server.py** - 主入口和路由管理
- **职责**：FastAPI应用实例，定义所有HTTP端点
- **主要功能**：
  - 处理CORS配置
  - 定义请求/响应模型（Pydantic）
  - 路由请求到相应的控制器
  - 服务器启动时的初始化逻辑
- **关键接口**：
  - `POST /battle` - 创建对战
  - `POST /vote/{battle_id}` - 提交投票
  - `GET /leaderboard` - 获取排行榜
  - `GET /battle/{battle_id}` - 获取对战详情

### 2. **battle_controller.py** - 对战管理
- **职责**：管理对战的创建和执行
- **主要功能**：
  - 根据对战等级（高端/低端）和匹配算法选择模型
  - 包含“过渡区”匹配逻辑，以增加跨级挑战机会
  - 选择固定提示词
  - 并发调用模型API获取响应
  - 管理对战会话状态
  - 支持流式响应（未来功能）
- **数据结构**：
  - `BattleSession` - 对战会话对象
  - 内存缓存活跃和已完成的对战

### 3. **vote_controller.py** - 投票系统
- **职责**：处理用户投票和防作弊
- **主要功能**：
  - 验证投票合法性
  - 防作弊机制（基于Discord ID）
  - 触发Glicko-2评分更新（实时或批量）
  - 更新对战状态
- **用户识别**：
  - 使用`discord:用户ID`格式
  - SHA256哈希存储以保护隐私

### 4. **storage.py** - 数据持久化层
- **职责**：管理所有数据的存储和读取
- **数据库**：SQLite（使用WAL模式提高并发性）
- **主要表结构**：
  - `models` - 模型评分信息
  - `battles` - 对战记录
  - `voting_history` - 投票历史
- **特性**：
  - 事务支持（ACID保证）
  - 索引优化查询性能
  - 线程安全的连接管理
- **缓存文件**：
  - `fixed_prompt_responses.json` - 预生成的高质量响应

### 5. **glicko2_rating.py** - Glicko-2评分系统
- **职责**：计算和维护模型评分
- **算法**：Glicko-2
- **主要功能**：
  - 处理胜/负/平局结果，更新模型的评分、评分偏差和波动性
  - 支持实时更新和周期性批量更新两种模式
  - 生成实时排行榜
  - 计算胜率统计
- **胜率计算**：`(胜场 + 0.5 * 平局) / 总场次`

### 6. **config.py** - 配置管理
- **职责**：集中管理所有配置
- **配置内容**：
  - 模型列表（从`config/models.json`加载）
  - 固定提示词（从`config/fixed_prompts.json`加载）
  - Glicko-2系统参数
  - 分级与匹配参数
  - 投票防作弊参数
- **验证功能**：
  - 启动时验证配置完整性
  - 确保至少有2个模型可用

### 7. **model_client.py** - 模型API客户端
- **职责**：统一的模型API调用接口
- **主要功能**：
  - 调用OpenAI格式的API
  - 自动重试机制（空响应处理）
  - 超时和错误处理
- **配置**（通过.env文件）：
  - API_ENDPOINT - API地址
  - API_KEY - 认证密钥
- **特性**：
  - 最多2次重试
  - 60秒超时设置
  - 空响应检测和处理

### 8. **logger_config.py** - 日志系统
- **职责**：统一的日志记录
- **日志类型**：
  - API请求日志
  - 对战事件日志
  - 投票事件日志
  - 错误日志
- **输出格式**：JSON格式化，包含时间戳
- **输出目标**：控制台和文件（`logs/`目录）

### 9. **fixed_prompt_response_generator.py** - 响应预生成工具
- **职责**：为固定提示词预生成高质量响应
- **用途**：第一阶段使用，避免实时API调用
- **功能**：
  - 批量生成响应
  - 保存到缓存文件
  - 支持增量更新

## 数据流程

### 对战创建流程
1. 客户端请求创建对战（提供`battle_type`和Discord ID）
2. 系统根据`battle_type`（高端/低端）和匹配算法选择2个模型
3. 系统随机选择固定提示词
4. 并发调用模型API获取响应
5. 保存对战记录，返回匿名响应

### 投票流程
1. 用户提交投票（包含Discord ID）
2. 验证用户身份（Discord ID哈希）
3. 检查防作弊规则
4. 开启数据库事务
5. 更新Glicko-2评分（或加入待处理队列）
6. 保存投票记录
7. 揭示模型名称

### 排行榜生成
1. 从数据库读取最新模型评分
2. 计算胜率等统计数据
3. 按ELO评分排序
4. 返回排行榜数据

## 技术栈
- **框架**：FastAPI (Python)
- **数据库**：SQLite with WAL mode
- **异步支持**：asyncio
- **API标准**：RESTful, OpenAI格式
- **认证**：Discord ID为基础的用户识别

## 部署注意事项
1. 确保`config/`目录包含必要的配置文件
2. 设置`.env`文件中的API密钥
3. 初次运行时会自动创建数据库
4. 建议使用反向代理处理HTTPS
5. 生产环境需要配置适当的CORS策略