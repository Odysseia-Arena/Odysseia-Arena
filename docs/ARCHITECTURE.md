# 系统架构文档

## 项目概述
创意写作大模型竞技场是一个让不同AI模型进行创意写作对战的平台。用户可以对比不同模型的创作质量并投票，系统使用ELO评分系统维护模型排行榜。

## 项目阶段
- **第一阶段**（当前）：固定提示词对战 - 系统提供预设的创作提示词
- **第二阶段**（已实现但隐藏）：自定义提示词对战 - 用户可以输入自己的提示词

## 系统架构图

```
┌─────────────────────────────────────────────┐
│                 客户端                       │
│        (Discord Bot / Web Interface)        │
└─────────────────┬───────────────────────────┘
                  │ HTTP/REST API
                  ↓
┌─────────────────────────────────────────────┐
│            FastAPI Server                    │
│           (arena_server.py)                  │
├─────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐        │
│  │Battle Control│  │Vote Control  │        │
│  │Controller    │  │Controller    │        │
│  └──────┬───────┘  └──────┬───────┘        │
│         │                  │                 │
│  ┌──────┴──────────────────┴───────┐        │
│  │        Storage Layer            │        │
│  │      (SQLite Database)          │        │
│  └──────────────────────────────────┘        │
│                                              │
│  ┌──────────────┐  ┌──────────────┐        │
│  │ ELO Rating   │  │Model Client  │        │
│  │   System     │  │  (API调用)   │        │
│  └──────────────┘  └──────────────┘        │
└─────────────────────────────────────────────┘
```

## 核心模块说明

### 1. **arena_server.py** - 主入口和路由管理
- **职责**：FastAPI应用实例，定义所有HTTP端点
- **主要功能**：
  - 处理CORS配置
  - 定义请求/响应模型（Pydantic）
  - 路由请求到相应的控制器
  - 服务器启动时的初始化逻辑
- **关键接口**：
  - `POST /battle` - 创建对战
  - `POST /vote/{battle_id}` - 提交投票
  - `GET /leaderboard` - 获取排行榜
  - `GET /battle/{battle_id}` - 获取对战详情

### 2. **battle_controller.py** - 对战管理和等级系统
- **职责**：管理对战的创建、执行和模型等级选择
- **主要功能**：
  - 支持高端和低端等级对战选择
  - 实现过渡区匹配机制（概率选择）
  - 随机选择两个不同的模型（考虑等级和权重）
  - 选择或接收提示词
  - 并发调用模型API获取响应
  - 管理对战会话状态
  - 支持流式响应（未来功能）
- **等级系统**：
  - 高端模型（high_tier）：评分较高的模型
  - 低端模型（low_tier）：评分较低的模型
  - 过渡区：高端末尾N个 + 低端开头N个模型
  - 概率机制：小概率选择过渡区模型确保积分平衡
- **数据结构**：
  - `BattleSession` - 对战会话对象
  - 内存缓存活跃和已完成的对战

### 3. **vote_controller.py** - 投票系统
- **职责**：处理用户投票和防作弊
- **主要功能**：
  - 验证投票合法性
  - 防作弊机制（基于Discord ID）
    - 30分钟内防重复投票
    - 用户速率限制（每小时最多100票）
  - 触发ELO评分更新
  - 更新对战状态
- **用户识别**：
  - 使用`discord:用户ID`格式
  - SHA256哈希存储以保护隐私

### 4. **storage.py** - 数据持久化层
- **职责**：管理所有数据的存储和读取
- **数据库**：SQLite（使用WAL模式提高并发性）
- **主要表结构**：
  - `models` - 模型评分信息
  - `battles` - 对战记录
  - `voting_history` - 投票历史
- **特性**：
  - 事务支持（ACID保证）
  - 索引优化查询性能
  - 线程安全的连接管理
- **缓存文件**：
  - `fixed_prompt_responses.json` - 预生成的高质量响应

### 5. **elo_rating.py** - ELO评分系统
- **职责**：计算和维护模型评分
- **配置**：
  - 初始评分：1200
  - K因子：32（评分变化幅度）
- **主要功能**：
  - 计算ELO评分变化
  - 处理胜/负/平局结果
  - 生成实时排行榜
  - 计算胜率统计
- **胜率计算**：`(胜场 + 0.5 * 平局) / 总场次`

### 6. **config.py** - 配置管理
- **职责**：集中管理所有配置
- **配置内容**：
  - 模型列表（从`config/models.json`加载）
  - 固定提示词（从`config/fixed_prompts.json`加载）
  - ELO系统参数
  - 投票防作弊参数
- **验证功能**：
  - 启动时验证配置完整性
  - 确保至少有2个模型可用

### 7. **model_client.py** - 模型API客户端
- **职责**：统一的模型API调用接口
- **主要功能**：
  - 调用OpenAI格式的API
  - 自动重试机制（空响应处理）
  - 超时和错误处理
- **配置**（通过.env文件）：
  - API_ENDPOINT - API地址
  - API_KEY - 认证密钥
- **特性**：
  - 最多2次重试
  - 60秒超时设置
  - 空响应检测和处理

### 8. **logger_config.py** - 日志系统
- **职责**：统一的日志记录
- **日志类型**：
  - API请求日志
  - 对战事件日志
  - 投票事件日志
  - 错误日志
- **输出格式**：JSON格式化，包含时间戳
- **输出目标**：控制台和文件（`logs/`目录）

### 9. **fixed_prompt_response_generator.py** - 响应预生成工具
- **职责**：为固定提示词预生成高质量响应
- **用途**：第一阶段使用，避免实时API调用
- **功能**：
  - 批量生成响应
  - 保存到缓存文件
  - 支持增量更新

### 10. **tier_manager.py** - 模型等级管理
- **职责**：管理模型的等级划分和升降级操作
- **主要功能**：
  - 初始化模型等级（根据评分自动划分高端/低端）
  - 执行每日升降级任务
  - 维护等级平衡（高端和低端模型数量大致相等）
- **升降级规则**：
  - 每天结算一次积分
  - 积分最低的N个高端模型降级到低端
  - 积分最高的N个低端模型升级到高端
  - N值可配置（默认3）
- **初始化策略**：
  - 首次运行时根据当前评分排序
  - 模型总数一半（向上取整）划分为高端
  - 剩余模型划分为低端

### 11. **battle_cleaner.py** - 后台清理和升降级调度
- **职责**：管理后台任务，包括清理超时的对战和定期模型升降级
- **主要功能**：
  - 清理超时的`pending_vote`状态对战（30分钟超时）
  - 清理卡住的`pending_generation`状态对战（基于配置的生成超时）
  - 定期运行模型升降级任务（每天一次）
  - 维护模型等级系统，支持高端和低端模型分组
  - 过渡区匹配机制，确保积分平衡
- **配置**：
  - 清理间隔：5分钟
  - 升降级间隔：24小时
  - 超时时间：30分钟（投票），可配置（生成）
- **后台线程**：
  - `run_battle_cleaner()` - 持续清理超时代码
  - `run_promotion_relegation_scheduler()` - 每日升降级调度

## 数据流程

### 对战创建流程
1. 客户端请求创建对战（提供Discord ID）
2. 系统随机选择2个模型
3. 第一阶段：随机选择固定提示词
4. 优先从缓存加载响应，否则调用API
5. 保存对战记录，返回匿名响应

### 投票流程
1. 用户提交投票（包含Discord ID）
2. 验证用户身份（Discord ID哈希）
3. 检查防作弊规则
4. 开启数据库事务
5. 更新ELO评分
6. 保存投票记录
7. 揭示模型名称

### 排行榜生成
1. 从数据库读取最新模型评分
2. 计算胜率等统计数据
3. 按ELO评分排序
4. 返回排行榜数据

## 技术栈
- **框架**：FastAPI (Python)
- **数据库**：SQLite with WAL mode
- **异步支持**：asyncio
- **API标准**：RESTful, OpenAI格式
- **认证**：Discord ID为基础的用户识别

## 部署注意事项
1. 确保`config/`目录包含必要的配置文件
2. 设置`.env`文件中的API密钥
3. 初次运行时会自动创建数据库
4. 建议使用反向代理处理HTTPS
5. 生产环境需要配置适当的CORS策略