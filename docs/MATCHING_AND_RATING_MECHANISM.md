# 匹配与评分机制详解

本文档详细阐述了 Odysseia Arena 系统中用于模型对战的匹配选择机制和赛后评分更新机制。

## 1. 匹配机制

系统的核心目标是提供公平且有趣的对战。为实现这一目标，我们设计了一套基于模型分级和概率性选择的动态匹配系统。

### 1.1 模型分级

所有活动模型根据其当前的评分 (`rating`) 被动态地划分为三个主要区域：

-   **高端局 (High Tier):** 包含评分较高的模型。
-   **低端局 (Low Tier):** 包含评分较低的模型。
-   **过渡区 (Transition Zone):** 这是一个特殊的重叠区域，由“高端局”的末尾N个模型和“低端局”的头部N个模型组成。这个区域的目的是促进不同等级间的模型流动和竞争，使得评分变化更具动态性。`N` 的大小在系统配置中定义 (`TRANSITION_ZONE_SIZE`)。

模型的分级状态是动态的，会随着每次周期性评分更新而调整。

### 1.2 匹配流程

当用户请求一场对战（例如，选择“高端局对战”）时，系统会按照以下概率流程选择两个模型：

1.  **确定基础池 (Base Pool):** 根据用户的选择，确定基础的模型池（例如，所有 `high_tier_models`）。

2.  **概率性选择对战模式:** 系统会生成一个随机数，根据预设的概率触发不同的对战模式：

    -   **跨级挑战 (Cross-Tier Challenge):** 有较小概率触发。系统会从用户选择的基础池中选择一个模型，而其对手则从**所有活动模型**中随机选择。这为低端模型提供了挑战高端模型创造“爆冷”机会，也考验了高端模型的稳定性。

    -   **过渡区挑战 (Transition Zone Challenge):** 有一定概率触发。此模式下，系统会确保**至少一个模型**来自用户所选等级与过渡区的交集，而**另一个模型**则从整个过渡区中选择。这加强了“准高端”和“准低端”模型之间的竞争。

    -   **常规匹配 (Standard Match):** 如果以上两种特殊模式均未触发，则执行常规匹配。两个模型都将从用户选择的基础池中（例如，高端局 vs 高端局）进行选择。

3.  **模型抽样:** 在确定了对战双方的池子后，系统会根据每个模型配置的 `weight` (权重) 进行加权随机抽样，选出最终的两个对战模型。权重越高的模型被选中的概率越大。

### 1.3 特殊规则

-   **自我对战避免:** 系统会确保选出的两个模型不是同一个模型。
-   **预设答案过滤:** 如果一个模型被配置为使用“预设答案”，系统会检查该模型是否拥有针对当前随机抽中的提示词 (`prompt_id`) 的答案。如果没有，该模型将被临时从本次匹配的池子中移除，以确保对战可以正常进行。
-   **失败重试:** 如果在调用模型API时发生错误，系统会自动将出错的模型排除，并尝试重新选择模型进行对战，最多重试3次，以提高对战创建的成功率。

## 2. 评分机制

系统采用先进的 **Glicko-2 评分算法**来评估和更新每个模型的实力评分。相比传统的 Elo 算法，Glicko-2 提供了更准确的实力评估，因为它额外考虑了两个重要参数。

### 2.1 Glicko-2 核心参数

每个模型都拥有三个核心Glicko-2参数：

-   **评分 (Rating, μ):** 代表模型的实力值，类似于 Elo 分数。初始值通常为1500。
-   **评分偏差 (Rating Deviation, RD, φ):** 衡量模型评分的不确定性。RD 越高，表示系统对该模型的真实实力越不确定。新模型的 RD 会很高，而参赛次数多的模型的 RD 会逐渐降低。
-   **评分波动率 (Rating Volatility, σ):** 衡量模型实力表现的稳定性。表现时好时坏、经常爆冷或被爆冷的模型，其波动率会较高。

一场比赛的结果不仅会改变双方的评分，还会根据比赛的意外程度调整他们的 RD 和波动率。

### 2.2 评分更新流程

系统结合了两种更新模式，以兼顾即时反馈和长期稳定：

#### 2.2.1 实时更新 (Real-time Update)

-   **触发时机:** 每当一场对战的投票结果产生后，立即触发。
-   **更新对象:** 系统会更新一组独立的**实时评分** (`rating_realtime`, `rating_deviation_realtime`, `volatility_realtime`)。
-   **目的:** 为用户提供即时反馈，让排行榜能够迅速反映最新战况。这部分评分变化较快，但可能存在短期波动。

#### 2.2.2 周期性批量更新 (Periodic Batch Update)

-   **触发时机:** 由一个后台线程 (`rating_updater.py`) 负责，按固定的时间周期（例如，每小时）自动执行。
-   **更新对象:**
    1.  系统会获取自上一个周期以来所有已完成的对战结果。
    2.  使用这些结果对每个模型进行**一次性批量计算**，更新其主要的、更稳定的评分 (`rating`, `rating_deviation`, `volatility`)。
    3.  更新完成后，系统会将新的主评分**同步**到实时评分上，为下一个更新周期建立新的基线。
-   **目的:** 批量更新可以更准确地反映模型在一个周期内的综合表现，减少单场比赛偶然性带来的噪声，使得主评分更加稳定和可靠。排行榜的正式排名基于此主评分。

### 2.3 初始分数生成 (Initial Score Calculation)

为了给新加入系统的模型或整个系统一个合理的初始评分，我们使用一个独立的脚本 (`calculate_bt_scores.py`) 来进行冷启动计算。

-   **算法:** 该脚本使用 **Bradley-Terry (BT) 模型**，这是一种基于成对比较（即对战结果）来估计参与者相对实力的统计模型。
-   **流程:**
    1.  脚本会读取数据库中所有已完成的对战历史。
    2.  通过最大似然估计 (MLE) 算法，计算出每个模型在自然对数尺度下的相对实力评分 (`beta` 值)。
    3.  同时，通过计算 Hessian 矩阵的逆，可以估算出每个评分的方差，这代表了评分的不确定性。
    4.  最后，将 BT 模型的 `beta` 值和方差**缩放**到 Glicko-2 的尺度上，生成初始的 `rating` (均值为1500) 和 `rating_deviation`。
-   **目的:** 这种方法为 Glicko-2 系统提供了一个比“所有模型均从1500分开始”更科学、更反映历史战绩的初始状态，有助于评分系统更快地收敛到模型的真实实力水平。